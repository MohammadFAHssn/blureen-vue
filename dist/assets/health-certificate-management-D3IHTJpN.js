import{_ as ie}from"./AreYouSureDialog-CeFabMiA.js";import{_ as L}from"./DialogCloseBtn-Dpes8imm.js";import{r as k,f as E,o as v,e as l,b as e,m as A,v as y,d as C,bO as le,c as F,x as H,bx as K,bq as I,n as s,am as U,a as Q,aF as z,bK as S,w as se,bN as oe,F as re,i as ne,M as de,bP as T,Y as ue,bQ as fe}from"./index-DzAJoBi0.js";import{V as O,b as J,c as me}from"./VCard-BQ--ty01.js";import{V as _}from"./VCardText-lubmdu70.js";import{V as W}from"./VForm-CpBJjj7p.js";import{V as G,a as M}from"./VRow-BecNRLVG.js";import{V as ce}from"./VFileInput-YQ_t2ZIy.js";import{V as q}from"./VDialog-DuS75Z6u.js";import{r as X}from"./validators-DkGyzL9w.js";import{V as Z}from"./VTextField-BSUamdXC.js";import{$}from"./api-CLydqfbv.js";import{V as ge}from"./VTable-BQCZI2I5.js";import{u as he}from"./useAGGridTheme--LAcMOX1.js";import{V as be}from"./VSnackbar-DpV4yPRS.js";import{V as pe}from"./VFab-CDsNrgkQ.js";import{V as Ve}from"./VLayout-BLHScoLq.js";import"./createSimpleFunctional-mx-9zXDN.js";/* empty css              */import"./VField-B5h3iqTV.js";import"./VOverlay-BffWH9mI.js";import"./VCounter-BUZDmVSZ.js";import"./dialog-transition-BGQ0C-rU.js";import"./helpers-4BKJjDfb.js";import"./useLogout-B5pdDczR.js";const Ce={class:"text-caption d-flex justify-space-between"},De={key:0},ve={__name:"HealthCertificateAddImageDialog",props:{loading:Boolean,isDialogVisible:Boolean,progress:{type:Number,default:0},total:{type:Number,default:0},done:{type:Number,default:0},failed:{type:Number,default:0}},emits:["submit","update:isDialogVisible"],setup(n,{emit:a}){const d=n,b=a,p=k(),u=k([]),V=[r=>{if(!r.length)return"حداقل یک تصویر انتخاب کنید!";if(r.length>3e3)return"حداکثر می‌توانید 3000 تصویر انتخاب کنید!";for(const i of r){const h=i.name.split(".").pop().toLowerCase();if(!["jpg","jpeg","png"].includes(h))return"فقط فایل‌های تصویری (jpg, jpeg, png) مجاز هستند!";if(i.size>2*1024*1024)return`حجم هر تصویر باید کمتر از ${2*1024*1024/1024/1024} مگابایت باشد!`}return!0}];function N(){var r;(r=p.value)==null||r.validate().then(({valid:i})=>{i&&b("submit",{healthCertificateImages:u.value})})}function D(){b("update:isDialogVisible",!1)}function f(r){b("update:isDialogVisible",r)}return(r,i)=>{const h=L;return v(),E(q,{width:r.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":f},{default:l(()=>[e(h,{onClick:i[0]||(i[0]=w=>f(!1))}),e(O,null,{default:l(()=>[e(J,{class:"text-h6"},{default:l(()=>[...i[2]||(i[2]=[y(" افزودن عکس ",-1)])]),_:1}),n.loading?(v(),E(_,{key:0,class:"pt-0"},{default:l(()=>[e(le,{"model-value":n.progress,height:"10",color:"primary",rounded:"",striped:"",class:"mb-2"},null,8,["model-value"]),C("div",Ce,[i[3]||(i[3]=C("span",null,"در حال آپلود...",-1)),C("span",null,[y(H(n.done)+" / "+H(n.total)+" ",1),n.failed?(v(),F("span",De," | ناموفق: "+H(n.failed),1)):A("",!0),y(" | "+H(Math.round(n.progress))+"% ",1)])])]),_:1})):A("",!0),e(_,null,{default:l(()=>[e(W,{ref_key:"refVForm",ref:p,class:"mt-2","validate-on":"submit lazy",onSubmit:K(N,["prevent"])},{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",md:"12"},{default:l(()=>[e(ce,{modelValue:s(u),"onUpdate:modelValue":i[1]||(i[1]=w=>I(u)?u.value=w:null),multiple:"",chips:"","show-size":"",disabled:n.loading,label:"تصاویر (حداکثر 3000 فایل)",accept:"image/*",rules:V},null,8,["modelValue","disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e(U,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...i[4]||(i[4]=[y(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e(U,{color:"secondary",variant:"tonal",disabled:n.loading,onClick:D},{default:l(()=>[...i[5]||(i[5]=[y(" انصراف ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},ye={__name:"HealthCertificateCreateDialog",props:{isDialogVisible:{type:Boolean,required:!0},loading:{type:Boolean,required:!0}},emits:["submit","update:isDialogVisible"],setup(n,{emit:a}){const d=n,b=a,p=k(),u=k(null),V=k([]),N=[()=>!!u.value||"لطفا دوره را انتخاب کنید!"];function D(){var i;(i=p.value)==null||i.validate().then(({valid:h})=>{h&&b("submit",{healthCertificateDate:u.value,healthCertificateName:V.value})})}function f(){b("update:isDialogVisible",!1)}function r(i){b("update:isDialogVisible",i)}return(i,h)=>{const w=L,m=Q("PersianDatetimePicker");return v(),E(q,{width:i.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":r},{default:l(()=>[e(w,{onClick:h[0]||(h[0]=Y=>r(!1))}),e(O,null,{default:l(()=>[e(_,null,{default:l(()=>[h[5]||(h[5]=C("h4",{class:"text-h5 text-center mb-2"}," ایجاد گروه شناسنامه جدید ",-1)),e(W,{ref_key:"refVForm",ref:p,class:"mt-6","validate-on":"submit lazy",onSubmit:K(D,["prevent"])},{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{disabled:n.loading},{default:l(()=>[e(s(Z),{modelValue:s(V),"onUpdate:modelValue":h[1]||(h[1]=Y=>I(V)?V.value=Y:null),rules:["requiredValidator"in i?i.requiredValidator:s(X)],disabled:n.loading,simple:"",label:"نام"},null,8,["modelValue","rules","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{rules:N,disabled:n.loading},{default:l(()=>[e(m,{modelValue:s(u),"onUpdate:modelValue":h[2]||(h[2]=Y=>I(u)?u.value=Y:null),disabled:n.loading,type:"year-month",simple:"",label:"دوره شناسنامه"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e(U,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...h[3]||(h[3]=[y(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e(U,{color:"secondary",variant:"tonal",onClick:f},{default:l(()=>[...h[4]||(h[4]=[y(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},He={key:0,class:"d-flex justify-center align-center h-100"},ke={key:1},we={key:2,class:"text-center text-medium-emphasis mt-3"},je={__name:"HealthCertificateDetailsDialog",props:{file:Object,loading:Boolean,isDialogVisible:Boolean},emits:["update:isDialogVisible"],setup(n,{emit:a}){const d=n,b=a,p=S({fetchingHealthCertificateUsers:!1}),u=k([]),V=S({hasError:!1,message:""});async function N(D){if(D){p.fetchingHealthCertificateUsers=!0;try{const f=await $(`/hse/health-certificate/file/${D}`,{method:"GET"});u.value=(f==null?void 0:f.data)??[],V.hasError=!1,V.message=""}catch(f){console.error("fetchHealthCertificateUsers error:",f),V.hasError=!0,V.message=(f==null?void 0:f.message)??"خطا در دریافت کاربران",u.value=[]}finally{p.fetchingHealthCertificateUsers=!1}}}return se(()=>{var D;return(D=d.file)==null?void 0:D.id},D=>{D?N(D):u.value=[]},{immediate:!0}),(D,f)=>(v(),E(q,{width:D.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":f[1]||(f[1]=r=>b("update:isDialogVisible",r))},{default:l(()=>[e(O,null,{default:l(()=>[e(J,{class:"text-h6 text-center"},{default:l(()=>[y(" کاربران دوره شناسنامه: "+H(d.file.name),1)]),_:1}),e(_,{class:"scrollable-content"},{default:l(()=>[s(p).fetchingHealthCertificateUsers?(v(),F("div",He,[e(oe,{indeterminate:"",color:"primary",size:"64"})])):s(u)?(v(),F("div",ke,[e(ge,{"fixed-header":"",height:400,density:"comfortable"},{default:l(()=>[f[2]||(f[2]=C("thead",null,[C("tr",null,[C("th",null,"ردیف"),C("th",null,"نام"),C("th",null,"کد پرسنلی"),C("th",null,"شناسنامه")])],-1)),C("tbody",null,[(v(!0),F(re,null,ne(s(u),(r,i)=>(v(),F("tr",{key:r.id},[C("td",null,H(i+1),1),C("td",null,H(r.first_name)+" "+H(r.last_name),1),C("td",null,H(r.personnel_code),1),C("td",null,H(r.health_certificate.some(h=>{var w;return h.health_certificate_id===((w=d.file)==null?void 0:w.id)})?"آپلود شده":"ندارد"),1)]))),128))])]),_:1})])):(v(),F("div",we," هیچ کاربری یافت نشد. "))]),_:1}),e(me,{class:"justify-end"},{default:l(()=>[e(U,{color:"primary",text:"",onClick:f[0]||(f[0]=r=>b("update:isDialogVisible",!1))},{default:l(()=>[...f[3]||(f[3]=[y(" بستن ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["width","model-value"]))}},Ee={__name:"HealthCertificateEditDialog",props:{file:Object,loading:Boolean,isDialogVisible:Boolean},emits:["submit","update:isDialogVisible"],setup(n,{emit:a}){const d=n,b=a,p=k(),u=k(null),V=k(d.file.name);function N(){var r;(r=p.value)==null||r.validate().then(({valid:i})=>{i&&b("submit",{healthCertificateDate:u.value,healthCertificateName:V.value})})}function D(){b("update:isDialogVisible",!1)}function f(r){b("update:isDialogVisible",r)}return(r,i)=>{const h=L,w=Q("PersianDatetimePicker");return v(),E(q,{width:r.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":f},{default:l(()=>[e(h,{onClick:i[0]||(i[0]=m=>f(!1))}),e(O,null,{default:l(()=>[e(J,{class:"text-h6"},{default:l(()=>[y(" ویرایش شناسنامه: "+H(d.file.name),1)]),_:1}),e(_,null,{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",sm:"6"},{default:l(()=>[C("p",null,[i[3]||(i[3]=C("strong",null,"ماه:",-1)),y(" "+H(d.file.month),1)])]),_:1}),e(M,{cols:"12",sm:"6"},{default:l(()=>[C("p",null,[i[4]||(i[4]=C("strong",null,"سال:",-1)),y(" "+H(d.file.year),1)])]),_:1})]),_:1}),e(W,{ref_key:"refVForm",ref:p,class:"mt-6","validate-on":"submit lazy",onSubmit:K(N,["prevent"])},{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{disabled:n.loading},{default:l(()=>[e(Z,{modelValue:s(V),"onUpdate:modelValue":i[1]||(i[1]=m=>I(V)?V.value=m:null),rules:["requiredValidator"in r?r.requiredValidator:s(X)],disabled:n.loading,simple:"",label:"نام"},null,8,["modelValue","rules","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{disabled:n.loading},{default:l(()=>[e(w,{modelValue:s(u),"onUpdate:modelValue":i[2]||(i[2]=m=>I(u)?u.value=m:null),disabled:n.loading,type:"year-month",simple:"",label:"دوره شناسنامه"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e(U,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...i[5]||(i[5]=[y(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e(U,{color:"secondary",variant:"tonal",onClick:D},{default:l(()=>[...i[6]||(i[6]=[y(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},Me={style:{"block-size":"100%"}},Ne={__name:"health-certificate-management",setup(n){const a=S({hasError:!1,errorMessage:"",isHealthCertificateCreateDialogVisible:!1,isHealthCertificateEditDialogVisible:!1,isHealthCertificateAddImageDialogVisible:!1,isHealthCertificateDeleteDialogVisible:!1,isHealthCertificateDetailsDialogVisible:!1}),d=S({createHealthCertificate:!1,editHealthCertificate:!1,addImageHealthCertificate:!1,fetchingHealthCertificates:!1,deleteHealthCertificate:!1,detailsHealthCertificate:!1}),b=k([]),p=k(null),u=k([]),V=k(null),{theme:N}=he();function D(c){V.value=c.api,V.value.setGridOption("loading",!0)}const f=k([{headerName:"نام",field:"name"},{headerName:"ماه",field:"month"},{headerName:"سال",field:"year"},{headerName:"بارگذاری توسط",field:"uploadedBy"},{headerName:"آخرین ویرایش توسط",field:"editedBy"},{headerName:"تاریخ بارگذاری",field:"createdAt",valueFormatter:c=>T(c.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"تاریخ آخرین ویرایش",field:"updatedAt",valueFormatter:c=>T(c.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"عملیات",field:"actions",cellRendererSelector:c=>({component:"Actions",params:{onDeleteClick:t=>{u.value=[t],a.isHealthCertificateDeleteDialogVisible=!0},onDetailsClick:t=>{u.value=[t],p.value=b.value.find(g=>g.id===t.data.id),a.isHealthCertificateDetailsDialogVisible=!0},onEditClick:t=>{u.value=[t],p.value=b.value.find(g=>g.id===t.data.id),a.isHealthCertificateEditDialogVisible=!0},onAddImageClick:t=>{u.value=[t],p.value=b.value.find(g=>g.id===t.data.id),a.isHealthCertificateAddImageDialogVisible=!0}}})}]),r=ue(()=>{var c;return(c=b.value)==null?void 0:c.map(t=>{var g,o;return{id:t.id,name:t.name,month:t.month,year:t.year,uploadedBy:((g=t.uploadedBy)==null?void 0:g.fullName)||"--",editedBy:((o=t.editedBy)==null?void 0:o.fullName)||"--",createdAt:T(t.createdAt).format("jYYYY-jMM-jDD HH:mm:ss"),updatedAt:T(t.updatedAt).format("jYYYY-jMM-jDD HH:mm:ss"),actions:{deletable:!0,detailsable:!0,editable:{status:!0,mode:"view"},addImage:!0}}})});async function i(){var c,t,g;d.fetchingHealthCertificates=!0,(c=V.value)==null||c.setGridOption("loading",!0);try{const o=await $("/hse/health-certificate/file/",{method:"GET"});b.value=((t=o==null?void 0:o.data)==null?void 0:t.healthCertificates)||[]}catch(o){console.error("Error fetching healthCertificates:",o),a.hasError=!0,a.errorMessage=o.message||"خطا در دریافت دوره‌های شناسنامه‌ها"}finally{d.fetchingHealthCertificates=!1,(g=V.value)==null||g.setGridOption("loading",!1)}}i();async function h(c){const t=new FormData;t.append("month",Number(c.healthCertificateDate.split("/")[1])),t.append("year",Number(c.healthCertificateDate.split("/")[0])),t.append("file_name",c.healthCertificateName),d.createHealthCertificate=!0;try{await $("/hse/health-certificate/file/",{method:"POST",body:t,onResponseError({response:g}){var o,x;if(a.hasError=!0,(o=g._data)!=null&&o.errors){const j=Object.values(g._data.errors).flat().join(" | ");a.errorMessage=j}else a.errorMessage=((x=g._data)==null?void 0:x.message)||"خطا در ایجاد"}}),a.isHealthCertificateCreateDialogVisible=!1}catch(g){console.error(g)}finally{d.createHealthCertificate=!1,i()}}async function w(c){const t=p.value.id,g=new FormData;c.healthCertificateDate&&(g.append("month",Number(c.healthCertificateDate.split("/")[1])),g.append("year",Number(c.healthCertificateDate.split("/")[0]))),g.append("file_name",c.healthCertificateName),d.editHealthCertificate=!0;try{await $(`/hse/health-certificate/file/${t}`,{method:"POST",body:g,onResponseError({response:o}){var x,j;if(a.hasError=!0,(x=o._data)!=null&&x.errors){const B=Object.values(o._data.errors).flat().join(" | ");a.errorMessage=B}else a.errorMessage=((j=o._data)==null?void 0:j.message)||"خطا در ویرایش"}}),a.isHealthCertificateEditDialogVisible=!1}catch(o){console.error(o)}finally{d.editHealthCertificate=!1,i()}}const m=S({active:!1,total:0,done:0,failed:0,percent:0});function Y(){m.active=!1,m.total=0,m.done=0,m.failed=0,m.percent=0}async function ee(c){const t=p.value.id,g=p.value.year,o=c.healthCertificateImages||[],x=19;if(o.length){Y(),m.active=!0,m.total=o.length,d.addImageHealthCertificate=!0,a.hasError=!1,a.errorMessage="";try{for(let j=0;j<o.length;j+=x){const B=o.slice(j,j+x),P=new FormData;B.forEach(R=>P.append("images[]",R,R.name)),P.append("id",String(t)),P.append("year",String(g));try{await $("/hse/health-certificate/file/image",{method:"POST",body:P}),m.done+=B.length}catch(R){console.error("batch upload failed:",R),m.failed+=B.length,a.hasError=!0,a.errorMessage="برخی از فایل‌ها بارگذاری نشدند."}const ae=m.done+m.failed;m.percent=m.total?ae/m.total*100:0}a.isHealthCertificateAddImageDialogVisible=!1}catch(j){console.error(j),a.hasError=!0,a.errorMessage="خطای غیرمنتظره در آپلود"}finally{d.addImageHealthCertificate=!1,m.active=!1,i()}}}async function te(){const c=u.value[0].data.id;d.deleteHealthCertificate=!0;try{await $(`/hse/health-certificate/file/${c}`,{method:"DELETE",onResponseError({response:t}){d.deleteHealthCertificate=!1,a.hasError=!0,a.errorMessage=t._data.message||"خطا در حذف"}}),d.deleteHealthCertificate=!1,a.isHealthCertificateDeleteDialogVisible=!1,b.value=b.value.filter(t=>t.id!==u.value[0].data.id)}catch(t){console.error(t)}}return(c,t)=>{const g=Q("AgGridVue");return v(),E(Ve,{class:"app-layout"},{default:l(()=>[e(be,{modelValue:s(a).hasError,"onUpdate:modelValue":t[0]||(t[0]=o=>s(a).hasError=o),timeout:2e3,location:"center",variant:"flat",color:"error"},{default:l(()=>[y(H(s(a).errorMessage),1)]),_:1},8,["modelValue"]),C("section",Me,[e(g,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":s(f),"row-data":s(r),"enable-rtl":"","row-numbers":"",pagination:"",theme:s(N),onGridReady:D},null,8,["column-defs","row-data","theme"])]),s(a).isHealthCertificateCreateDialogVisible?(v(),E(ye,{key:0,"is-dialog-visible":s(a).isHealthCertificateCreateDialogVisible,"onUpdate:isDialogVisible":t[1]||(t[1]=o=>s(a).isHealthCertificateCreateDialogVisible=o),loading:s(d).createHealthCertificate,onSubmit:h},null,8,["is-dialog-visible","loading"])):A("",!0),s(a).isHealthCertificateEditDialogVisible?(v(),E(Ee,{key:1,"is-dialog-visible":s(a).isHealthCertificateEditDialogVisible,"onUpdate:isDialogVisible":t[2]||(t[2]=o=>s(a).isHealthCertificateEditDialogVisible=o),loading:s(d).editHealthCertificate,file:s(p),onSubmit:w},null,8,["is-dialog-visible","loading","file"])):A("",!0),s(a).isHealthCertificateAddImageDialogVisible?(v(),E(ve,{key:2,"is-dialog-visible":s(a).isHealthCertificateAddImageDialogVisible,"onUpdate:isDialogVisible":t[3]||(t[3]=o=>s(a).isHealthCertificateAddImageDialogVisible=o),loading:s(d).addImageHealthCertificate||s(m).active,progress:s(m).percent,total:s(m).total,done:s(m).done,failed:s(m).failed,onSubmit:ee},null,8,["is-dialog-visible","loading","progress","total","done","failed"])):A("",!0),s(a).isHealthCertificateDetailsDialogVisible?(v(),E(je,{key:3,"is-dialog-visible":s(a).isHealthCertificateDetailsDialogVisible,"onUpdate:isDialogVisible":t[4]||(t[4]=o=>s(a).isHealthCertificateDetailsDialogVisible=o),loading:s(d).detailsHealthCertificate,file:s(p)},null,8,["is-dialog-visible","loading","file"])):A("",!0),s(a).isHealthCertificateDeleteDialogVisible?(v(),E(ie,{key:4,"is-dialog-visible":s(a).isHealthCertificateDeleteDialogVisible,"onUpdate:isDialogVisible":t[5]||(t[5]=o=>s(a).isHealthCertificateDeleteDialogVisible=o),title:"آیا از حذف این شناسنامه اطمینان دارید؟",loading:s(d).deleteHealthCertificate,onConfirm:te},null,8,["is-dialog-visible","loading"])):A("",!0),e(fe,null,{default:l(()=>[e(pe,{app:"",icon:"tabler-plus",size:"x-large",onClick:t[6]||(t[6]=o=>s(a).isHealthCertificateCreateDialogVisible=!0)})]),_:1})]),_:1})}}},tt=de(Ne,[["__scopeId","data-v-ac1f93f2"]]);export{tt as default};
