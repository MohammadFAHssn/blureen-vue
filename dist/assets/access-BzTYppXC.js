import{_ as K}from"./DialogCloseBtn-BQCqwgVG.js";import{V as Q,a as W,b as X,c as Z}from"./VCard-TiDRmG01.js";import{V as ee}from"./VContainer-CX8pogSh.js";import{V as te,a as G}from"./VRow-Fubp2vBO.js";import{r as f,Y as A,w as se,f as g,o as u,e as l,b as i,m as y,c as $,d as j,x as U,F as D,i as B,n as s,a2 as ae,v as M,a1 as L,bq as oe,am as le,M as ie,bI as q,bJ as re,a as ne}from"./index-BLa7l-A_.js";import{V as de}from"./VTextField-DuLJrTHU.js";import{V as F}from"./VDivider-DyTxU-Wi.js";import{V as ce}from"./VSkeletonLoader-D_7RdvlL.js";import{V as ue,a as me,b as fe}from"./VList-BZTViMpw.js";import{V as pe}from"./VDialog-sFXkKhbt.js";import{u as ge}from"./useAGGridTheme-CZ_PM4vS.js";import{u as T}from"./useApi-wYoMxalo.js";import{c as P}from"./createUrl-f0hm9zSJ.js";import{$ as he}from"./api-Dr13nQz4.js";import{i as z}from"./helpers-4BKJjDfb.js";import{V as Ve}from"./VSnackbar-DMIAQZI3.js";import{V as _e}from"./VLayout-Dw7eNUoQ.js";import"./createSimpleFunctional-DXSSxiVm.js";import"./VCardText-BdFJQOjq.js";/* empty css              */import"./autofocus-DrDz5aVi.js";import"./VCounter-D1LOcp_M.js";import"./VField-DHRx7IRv.js";import"./VOverlay-BtfhBX5a.js";import"./dialog-transition-Dn0iGl-1.js";import"./useLogout-D6I8nA1a.js";const be={class:"text-h6 mb-2 text-wrap"},ve={__name:"RelationManagerDialog",props:{isDialogVisible:{type:Boolean,required:!0},isFetchItemsPending:{type:Boolean,required:!0},items:{type:Array,required:!0},selected:{type:Array,required:!0},title:{type:String,required:!0},loading:{type:Boolean,required:!0}},emits:["update:isDialogVisible","change"],setup(V,{emit:w}){const _=V,o=w;function b(n){o("update:isDialogVisible",n)}const h=_.items,m=f(),p=f(""),r=f(h.filter(n=>_.selected.some(d=>d.id===n.id))),C=A(()=>r.value.length===h.length),E=A(()=>{const n=p.value.toLowerCase();return n?h.filter(d=>d.name.toLowerCase().includes(n)):h}),x=A(()=>{const n=[];for(const d of r.value)n.push(d);return n});se(r,()=>{p.value=""});function S(){o("change",r.value)}return(n,d)=>{const k=K;return u(),g(pe,{"model-value":_.isDialogVisible,width:n.$vuetify.display.smAndDown?"auto":800,"onUpdate:modelValue":b},{default:l(()=>[i(k,{onClick:d[0]||(d[0]=a=>n.$emit("update:isDialogVisible",!1))}),i(Q,null,{default:l(()=>[i(W,{class:"text-center"},{default:l(()=>[i(X,null,{default:l(()=>[j("h6",be,U(_.title),1)]),_:1})]),_:1}),i(ee,null,{default:l(()=>[i(te,{align:"center",justify:"start"},{default:l(()=>[(u(!0),$(D,null,B(s(x),(a,R)=>(u(),g(G,{key:a.id,class:"py-1 pe-0",cols:"auto"},{default:l(()=>[i(ae,{disabled:V.loading,closable:"","onClick:close":N=>s(r).splice(R,1)},{default:l(()=>[a.icon?(u(),g(L,{key:0,icon:a.icon,start:""},null,8,["icon"])):y("",!0),M(" "+U(a.name),1)]),_:2},1032,["disabled","onClick:close"])]),_:2},1024))),128)),s(C)?y("",!0):(u(),g(G,{key:0,cols:"12"},{default:l(()=>[i(de,{ref_key:"searchField",ref:m,modelValue:s(p),"onUpdate:modelValue":d[1]||(d[1]=a=>oe(p)?p.value=a:null),label:"Search","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1}))]),_:1})]),_:1}),s(C)?y("",!0):(u(),g(F,{key:0})),V.isFetchItemsPending?(u(),$(D,{key:1},B(3,a=>i(ce,{key:a,type:"list-item"})),64)):y("",!0),i(ue,null,{default:l(()=>[(u(!0),$(D,null,B(s(E),a=>(u(),$(D,null,[s(r).includes(a)?y("",!0):(u(),g(me,{key:a.id,disabled:V.loading,onClick:R=>s(r).push(a)},{prepend:l(()=>[a.icon?(u(),g(L,{key:0,disabled:V.loading,icon:a.icon},null,8,["disabled","icon"])):y("",!0)]),default:l(()=>[i(fe,{textContent:U(a.name)},null,8,["textContent"])]),_:2},1032,["disabled","onClick"]))],64))),256))]),_:1}),i(F),i(Z,null,{default:l(()=>[i(le,{loading:V.loading,color:"purple",variant:"text",onClick:S},{default:l(()=>[...d[2]||(d[2]=[M(" ذخیره ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value","width"])}}},ye={class:"ag-grid-sec"},we={__name:"access",async setup(V){let w,_;const o=q({hasError:!1,errorMessage:"",isEditAccessDialogVisible:!1}),b=f([]),h=f([]),m=f([]),p=f([]),r=q({fetchingRoles:!1,updatingUserRoles:!1}),{theme:C}=ge(),E=f(null);function x(e){E.value=e.api}const S=f({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:e=>e.field==="user"}),n=f([{headerName:"کاربر",field:"user"},{headerName:"نقش",field:"role"},{headerName:"مجوز",field:"permission"}]),d=f({enableRowGroup:!0,rowGroup:!0});function k(e){e.node.isSelected()||(e.api.deselectAll(),e.node.setSelected(!0));const t=e.api.getSelectedNodes(),c=[];return t.forEach(v=>{c.push(v.groupValue.split("-")[0].trim())}),c.length?[{icon:'<i class="tabler tabler-edit" style="font-size: 18px;"></i>',name:"ویرایش دسترسی",action:()=>{N(c),J(),o.isEditAccessDialogVisible=!0}},"separator",...e.defaultItems]:[...e.defaultItems]}async function a(){try{const{data:e,error:t}=await T(P("/base/user?fields[users]=id,personnel_code,first_name,last_name&fields[roles]=id,name&fields[roles.permissions]=name&include=roles.permissions"));if(t.value)throw t.value;b.value=e.value.data}catch(e){console.error("Error fetching user access:",e),o.hasError=!0,o.errorMessage=e.message||"خطا در دریافت دسترسی کاربران"}}async function R(){r.fetchingRoles=!0;try{const{data:e,error:t}=await T(P("/base/role?include=permissions"));if(r.fetchingRoles=!1,t.value)throw t.value;h.value=e.value.data}catch(e){console.error("Error fetching roles:",e),o.hasError=!0,o.errorMessage=e.message||"خطا در دریافت لیست نقش‌ها"}}function N(e){m.value=[],e.forEach(t=>{m.value.push(b.value.find(c=>c.personnel_code===t))})}function J(){m.value.length>1?p.value=[]:p.value=m.value[0].roles.map(e=>({id:e.id,name:e.name}))}async function O(e){r.updatingUserRoles=!0;try{await he("/base/user-role/update",{method:"POST",body:{userId:m.value[0].id,roleIds:e.map(t=>t.id)},onResponseError({response:t}){r.updatingUserRoles=!1,o.hasError=!0,o.errorMessage=t._data.message||"خطا در بروزرسانی دسترسی‌ها"}}),r.updatingUserRoles=!1,o.isEditAccessDialogVisible=!1,Y(e)}catch(t){console.error(t)}}function Y(e){b.value=b.value.map(t=>(t.id===m.value[0].id&&(t.roles=e.map(c=>h.value.find(v=>v.id===c.id))),t))}R(),[w,_]=re(()=>a()),await w,_();const H=A(()=>{const e=[];return b.value.map(t=>{z(t.roles)&&e.push({user:`${t.personnel_code} - ${t.first_name} ${t.last_name}`}),t.roles.map(c=>{z(c.permissions)&&e.push({user:`${t.personnel_code} - ${t.first_name} ${t.last_name}`,role:c.name}),c.permissions.map(v=>e.push({user:`${t.personnel_code} - ${t.first_name} ${t.last_name}`,role:c.name,permission:v.name}))})}),e});return(e,t)=>{const c=ve,v=ne("AgGridVue");return u(),g(_e,{class:"app-layout"},{default:l(()=>[i(Ve,{modelValue:s(o).hasError,"onUpdate:modelValue":t[0]||(t[0]=I=>s(o).hasError=I),timeout:2e3,location:"center",variant:"flat",color:"error"},{default:l(()=>[M(U(s(o).errorMessage),1)]),_:1},8,["modelValue"]),s(o).isEditAccessDialogVisible?(u(),g(c,{key:0,"is-dialog-visible":s(o).isEditAccessDialogVisible,"onUpdate:isDialogVisible":t[1]||(t[1]=I=>s(o).isEditAccessDialogVisible=I),title:`دسترسی ${s(m).length>1?"کاربران":`${s(m)[0].first_name} ${s(m)[0].last_name} (${s(m)[0].personnel_code})`}`,"is-fetch-items-pending":s(r).fetchingRoles,items:s(h),selected:s(p),loading:s(r).updatingUserRoles,onChange:O},null,8,["is-dialog-visible","title","is-fetch-items-pending","items","selected","loading"])):y("",!0),j("section",ye,[i(v,{theme:s(C),style:{"block-size":"100%","inline-size":"100%"},"column-defs":s(n),"row-data":s(H),"default-col-def":s(d),"row-numbers":"","cell-selection":"","row-selection":s(S),"enable-rtl":"",pagination:"","row-group-panel-show":"always","get-context-menu-items":k,onGridReady:x},null,8,["theme","column-defs","row-data","default-col-def","row-selection"])])]),_:1})}}},Ke=ie(we,[["__scopeId","data-v-7b2ba642"]]);export{Ke as default};
