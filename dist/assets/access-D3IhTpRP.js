import{_ as Y}from"./DialogCloseBtn-DClivir6.js";import{V as Z,a as K,b as Q,c as X}from"./VCard-CGnFAbwV.js";/* empty css              */import{av as ee,a6 as se,aq as te,aS as ae,ab as oe,b as l,J as le,y as ie,aW as ne,aZ as re,ad as ce,r as p,Y as A,w as de,f as v,o as m,e as i,m as b,c as D,d as j,x as S,F as $,i as B,n as t,a2 as ue,v as M,a1 as q,bq as me,am as fe,M as pe,bH as F,bI as ge,a as he}from"./index-BjMeilJt.js";import{V as Ve,a as G}from"./VRow-2DGINcT-.js";import{V as ve}from"./VTextField-DIU9dfNS.js";import{V as L}from"./VDivider-CBQIC_Ha.js";import{V as ye}from"./VSkeletonLoader-DkHMtmd5.js";import{V as _e,a as be,b as Ce}from"./VList-B5tnEd9a.js";import{V as we}from"./VDialog-aVsfsiqE.js";import{u as ke}from"./useAGGridTheme-PGEQEMks.js";import{u as P}from"./useApi-_Ac5YbRv.js";import{c as T}from"./createUrl-KnNem5TG.js";import{$ as Re}from"./api-C2gbrVEF.js";import{i as z}from"./helpers-4BKJjDfb.js";import{V as De}from"./VSnackbar-BrbKflsR.js";import{V as $e}from"./VLayout-kywf40YC.js";import"./createSimpleFunctional-BN4KE2Gh.js";import"./VCardText-Dzp4rHEe.js";import"./VCounter-CrplQ6YK.js";import"./VField-VxgXoxwn.js";import"./VOverlay-DKwWkzvN.js";import"./dialog-transition-C60lMhrI.js";import"./useLogout-CpIhXAAT.js";const Ae=se({fluid:{type:Boolean,default:!1},...ce(),...re(),...ne()},"VContainer"),Se=ee()({name:"VContainer",props:Ae(),setup(u,C){let{slots:g}=C;const{rtlClasses:a}=te(),{dimensionStyles:h}=ae(u);return oe(()=>l(u.tag,{class:ie(["v-container",{"v-container--fluid":u.fluid},a.value,u.class]),style:le([h.value,u.style])},g)),{}}}),Ue={class:"text-h6 mb-2 text-wrap"},Ee={__name:"RelationManagerDialog",props:{isDialogVisible:{type:Boolean,required:!0},isFetchItemsPending:{type:Boolean,required:!0},items:{type:Array,required:!0},selected:{type:Array,required:!0},title:{type:String,required:!0},loading:{type:Boolean,required:!0}},emits:["update:isDialogVisible","change"],setup(u,{emit:C}){const g=u,a=C;function h(r){a("update:isDialogVisible",r)}const y=g.items,f=p(),V=p(""),n=p(y.filter(r=>g.selected.some(c=>c.id===r.id))),w=A(()=>n.value.length===y.length),U=A(()=>{const r=V.value.toLowerCase();return r?y.filter(c=>c.name.toLowerCase().includes(r)):y}),E=A(()=>{const r=[];for(const c of n.value)r.push(c);return r});de(n,()=>{V.value=""});function x(){a("change",n.value)}return(r,c)=>{const k=Y;return m(),v(we,{"model-value":g.isDialogVisible,width:r.$vuetify.display.smAndDown?"auto":800,"onUpdate:modelValue":h},{default:i(()=>[l(k,{onClick:c[0]||(c[0]=o=>r.$emit("update:isDialogVisible",!1))}),l(Z,null,{default:i(()=>[l(K,{class:"text-center"},{default:i(()=>[l(Q,null,{default:i(()=>[j("h6",Ue,S(g.title),1)]),_:1})]),_:1}),l(Se,null,{default:i(()=>[l(Ve,{align:"center",justify:"start"},{default:i(()=>[(m(!0),D($,null,B(t(E),(o,R)=>(m(),v(G,{key:o.id,class:"py-1 pe-0",cols:"auto"},{default:i(()=>[l(ue,{disabled:u.loading,closable:"","onClick:close":N=>t(n).splice(R,1)},{default:i(()=>[o.icon?(m(),v(q,{key:0,icon:o.icon,start:""},null,8,["icon"])):b("",!0),M(" "+S(o.name),1)]),_:2},1032,["disabled","onClick:close"])]),_:2},1024))),128)),t(w)?b("",!0):(m(),v(G,{key:0,cols:"12"},{default:i(()=>[l(ve,{ref_key:"searchField",ref:f,modelValue:t(V),"onUpdate:modelValue":c[1]||(c[1]=o=>me(V)?V.value=o:null),label:"Search","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1}))]),_:1})]),_:1}),t(w)?b("",!0):(m(),v(L,{key:0})),u.isFetchItemsPending?(m(),D($,{key:1},B(3,o=>l(ye,{key:o,type:"list-item"})),64)):b("",!0),l(_e,null,{default:i(()=>[(m(!0),D($,null,B(t(U),o=>(m(),D($,null,[t(n).includes(o)?b("",!0):(m(),v(be,{key:o.id,disabled:u.loading,onClick:R=>t(n).push(o)},{prepend:i(()=>[o.icon?(m(),v(q,{key:0,disabled:u.loading,icon:o.icon},null,8,["disabled","icon"])):b("",!0)]),default:i(()=>[l(Ce,{textContent:S(o.name)},null,8,["textContent"])]),_:2},1032,["disabled","onClick"]))],64))),256))]),_:1}),l(L),l(X,null,{default:i(()=>[l(fe,{loading:u.loading,color:"purple",variant:"text",onClick:x},{default:i(()=>[...c[2]||(c[2]=[M(" ذخیره ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value","width"])}}},xe={class:"ag-grid-sec"},Ie={__name:"access",async setup(u){let C,g;const a=F({hasError:!1,errorMessage:"",isEditAccessDialogVisible:!1}),h=p([]),y=p([]),f=p([]),V=p([]),n=F({fetchingRoles:!1,updatingUserRoles:!1}),{theme:w}=ke(),U=p(null);function E(e){U.value=e.api}const x=p({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:e=>e.field==="user"}),r=p([{headerName:"کاربر",field:"user"},{headerName:"نقش",field:"role"},{headerName:"مجوز",field:"permission"}]),c=p({enableRowGroup:!0,rowGroup:!0});function k(e){e.node.isSelected()||(e.api.deselectAll(),e.node.setSelected(!0));const s=e.api.getSelectedNodes(),d=[];return s.forEach(_=>{d.push(_.groupValue.split("-")[0].trim())}),d.length?[{icon:'<i class="tabler tabler-edit" style="font-size: 18px;"></i>',name:"ویرایش دسترسی",action:()=>{N(d),H(),a.isEditAccessDialogVisible=!0}},"separator",...e.defaultItems]:[...e.defaultItems]}async function o(){try{const{data:e,error:s}=await P(T("/base/user?fields[users]=id,personnel_code,first_name,last_name&fields[roles]=id,name&fields[roles.permissions]=name&include=roles.permissions"));if(s.value)throw s.value;h.value=e.value.data}catch(e){console.error("Error fetching user access:",e),a.hasError=!0,a.errorMessage=e.message||"خطا در دریافت دسترسی کاربران"}}async function R(){n.fetchingRoles=!0;try{const{data:e,error:s}=await P(T("/base/role?include=permissions"));if(n.fetchingRoles=!1,s.value)throw s.value;y.value=e.value.data}catch(e){console.error("Error fetching roles:",e),a.hasError=!0,a.errorMessage=e.message||"خطا در دریافت لیست نقش‌ها"}}function N(e){f.value=[],e.forEach(s=>{f.value.push(h.value.find(d=>d.personnel_code===s))})}function H(){f.value.length>1?V.value=[]:V.value=f.value[0].roles.map(e=>({id:e.id,name:e.name}))}async function J(e){n.updatingUserRoles=!0;try{await Re("/base/user-role/update",{method:"POST",body:{userId:f.value[0].id,roleIds:e.map(s=>s.id)},onResponseError({response:s}){n.updatingUserRoles=!1,a.hasError=!0,a.errorMessage=s._data.message||"خطا در بروزرسانی دسترسی‌ها"}}),n.updatingUserRoles=!1,a.isEditAccessDialogVisible=!1,O(e)}catch(s){console.error(s)}}function O(e){h.value=h.value.map(s=>(s.id===f.value[0].id&&(s.roles=e.map(d=>y.value.find(_=>_.id===d.id))),s))}R(),[C,g]=ge(()=>o()),await C,g();const W=A(()=>{const e=[];return h.value.map(s=>{z(s.roles)&&e.push({user:`${s.personnel_code} - ${s.first_name} ${s.last_name}`}),s.roles.map(d=>{z(d.permissions)&&e.push({user:`${s.personnel_code} - ${s.first_name} ${s.last_name}`,role:d.name}),d.permissions.map(_=>e.push({user:`${s.personnel_code} - ${s.first_name} ${s.last_name}`,role:d.name,permission:_.name}))})}),e});return(e,s)=>{const d=Ee,_=he("AgGridVue");return m(),v($e,{class:"app-layout"},{default:i(()=>[l(De,{modelValue:t(a).hasError,"onUpdate:modelValue":s[0]||(s[0]=I=>t(a).hasError=I),timeout:2e3,location:"center",variant:"outlined",color:"error"},{default:i(()=>[M(S(t(a).errorMessage),1)]),_:1},8,["modelValue"]),t(a).isEditAccessDialogVisible?(m(),v(d,{key:0,"is-dialog-visible":t(a).isEditAccessDialogVisible,"onUpdate:isDialogVisible":s[1]||(s[1]=I=>t(a).isEditAccessDialogVisible=I),title:`دسترسی ${t(f).length>1?"کاربران":`${t(f)[0].first_name} ${t(f)[0].last_name} (${t(f)[0].personnel_code})`}`,"is-fetch-items-pending":t(n).fetchingRoles,items:t(y),selected:t(V),loading:t(n).updatingUserRoles,onChange:J},null,8,["is-dialog-visible","title","is-fetch-items-pending","items","selected","loading"])):b("",!0),j("section",xe,[l(_,{theme:t(w),style:{"block-size":"100%","inline-size":"100%"},"column-defs":t(r),"row-data":t(W),"default-col-def":t(c),"row-numbers":"","cell-selection":"","row-selection":t(x),"enable-rtl":"",pagination:"","row-group-panel-show":"always","get-context-menu-items":k,onGridReady:E},null,8,["theme","column-defs","row-data","default-col-def","row-selection"])])]),_:1})}}},os=pe(Ie,[["__scopeId","data-v-b4417713"]]);export{os as default};
