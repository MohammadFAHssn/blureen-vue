import{b as K,d as Q,V as W}from"./VCard-Bsc_93cL.js";import{f as N,o as m,e as n,b as _,v as y,a2 as F,x as V,c as D,F as X,i as Y,m as k,a1 as Z,am as S,M as ee,bL as P,r as c,a7 as ae,c8 as re,w as oe,a as te,d as j,n as l}from"./index-B2A7Sa9b.js";import{V as le}from"./VCardText-DXKYBdeZ.js";import{u as ie,V as ue}from"./VLayout-B2PDuM3R.js";import{u as B}from"./useApi-CR0_M8tr.js";import{c as T}from"./createUrl-3Fsu3BUH.js";import{$ as ne}from"./api-DF3aQ1IH.js";import{V as se}from"./VSnackbar-D82GW9Nj.js";import"./createSimpleFunctional-CEOQY3Sn.js";import"./useLogout-_1uCg_3h.js";import"./VOverlay-Bn9aD4vk.js";const de={__name:"ApprovalFlow",props:{requester:{required:!0},approvalFlow:{type:Array,required:!0},mode:{type:String,required:!0},loading:{type:Boolean,default:!0}},setup(v){const b=v;return(h,o)=>(m(),N(W,{class:"mb-9"},{default:n(()=>[_(K,null,{default:n(()=>[o[3]||(o[3]=y(" رده تأییدیه‌های ",-1)),_(F,{variant:"outlined",color:"info"},{default:n(()=>{var i,f,w;return[y(V((i=v.requester.data)==null?void 0:i.firstName)+" "+V((f=v.requester.data)==null?void 0:f.lastName)+" "+V((w=v.requester.groupValue)==null?void 0:w.name),1)]}),_:1})]),_:1}),_(le,{class:"d-flex align-center pa-5"},{default:n(()=>[(m(!0),D(X,null,Y(b.approvalFlow,(i,f)=>(m(),D("div",{key:f},[_(F,{color:"primary"},{default:n(()=>{var w,u,s;return[y(V((w=i.data)==null?void 0:w.firstName)+" "+V((u=i.data)==null?void 0:u.lastName)+" "+V((s=i.groupValue)==null?void 0:s.name),1)]}),_:2},1024),f!==b.approvalFlow.length-1?(m(),N(F,{key:0,variant:"text",color:"primary"},{default:n(()=>[_(Z,{icon:"tabler-chevron-left"})]),_:1})):k("",!0)]))),128))]),_:1}),_(Q,null,{default:n(()=>[v.mode==="edit"?(m(),N(S,{key:0,color:"success",loading:v.loading,onClick:o[0]||(o[0]=i=>h.$emit("save"))},{default:n(()=>[...o[4]||(o[4]=[y(" ذخیره ",-1)])]),_:1},8,["loading"])):k("",!0),v.mode==="edit"?(m(),N(S,{key:1,color:"error",disabled:v.loading,onClick:o[1]||(o[1]=i=>h.$emit("cancel"))},{default:n(()=>[...o[5]||(o[5]=[y(" بستن ",-1)])]),_:1},8,["disabled"])):k("",!0),v.mode==="view"?(m(),N(S,{key:2,color:"warning",onClick:o[2]||(o[2]=i=>h.$emit("edit"))},{default:n(()=>[...o[6]||(o[6]=[y(" ویرایش ",-1)])]),_:1})):k("",!0)]),_:1})]),_:1}))}},pe={style:{"block-size":"100%"}},ve={__name:"organization-chart",async setup(v){let b,h;const o=P({hasError:!1,errorMessage:""}),i=P({updateApprovalFlow:!1}),f=c([]),w=c([]),u=c(null),s=c([]),g=c("view"),t=ae(null),d=c([]),{theme:I}=ie();function M(e){t.value=e.api,t.value.setGridOption("rowData",G())}const O=c(e=>e.data.id),L=c([{headerName:"محل کار",field:"workplace",rowGroup:!0,hide:!0},{headerName:"منطقه کاری",field:"workArea",rowGroup:!0,hide:!0},{headerName:"مرکز هزینه",field:"costCenter",valueFormatter:e=>{var a;return(a=e.value)==null?void 0:a.name},rowGroup:!0,hide:!0},{headerName:"سمت شغلی",field:"jobPosition",valueFormatter:e=>{var a;return(a=e.value)==null?void 0:a.name},rowGroup:!0,hide:!0},{headerName:"کد پرسنلی",field:"personnelCode"},{headerName:"نام",field:"firstName"},{headerName:"نام خانوادگی",field:"lastName"},{headerName:"وضعیت",field:"active",cellRenderer:"Active",cellStyle:{display:"flex","align-items":"center"},filterParams:{valueFormatter:e=>e.value===1?"فعال":"غیرفعال"}}]),A=c({mode:"singleRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:e=>!(e.group&&e.field!=="jobPosition")});function G(){var e;return(e=f.value)==null?void 0:e.map(a=>{var r,p,q,C,$,x;return{id:a.id,personnelCode:Number.parseInt(a.personnel_code),firstName:a.first_name,lastName:a.last_name,active:a.active,workplace:(p=(r=a.profile)==null?void 0:r.workplace)==null?void 0:p.name,workArea:(C=(q=a.profile)==null?void 0:q.work_area)==null?void 0:C.name,costCenter:($=a.profile)==null?void 0:$.cost_center,jobPosition:(x=a.profile)==null?void 0:x.job_position,approvalFlowAsRequester:a.approval_flows_as_requester}})}const U=c({filter:"agGroupColumnFilter"});function R(e){let a;return t.value.forEachNode(r=>{var p,q,C;if(e.approver_user_id&&((p=r.data)==null?void 0:p.id)==e.approver_user_id||e.approver_position_id&&r.field==="jobPosition"&&((q=r.groupValue)==null?void 0:q.rayvarz_id)==e.approver_position_id&&((C=r.parent.groupValue)==null?void 0:C.rayvarz_id)==e.approver_center_id)return a=r,"break loop!"}),a}function H(){d.value=t.value.getSelectedNodes();for(const e of d.value)t.value.setRowNodeExpanded(e,!0,!0);if(g.value==="view"){if(d.value.length===0){s.value=[];return}if(u.value=d.value[0],d.value[0].field==="jobPosition"){const e=d.value[0].groupValue.rayvarz_id,a=d.value[0].parent.groupValue.rayvarz_id;s.value=w.value.filter(r=>r.requester_position_id===e&&r.requester_center_id===a).map(r=>R(r))}d.value[0].group||(s.value=d.value[0].data.approvalFlowAsRequester.map(e=>R(e)))}else g.value==="edit"&&(s.value=d.value)}async function z(){var e;try{const{data:a,error:r}=await B(T("/base/user/approval-flows-as-requester",{query:{requestTypeId:1}}));if(r.value)throw r.value;f.value=a.value.data,(e=t.value)==null||e.setGridOption("rowData",G())}catch(a){console.error("Error fetching users:",a),o.hasError=!0,o.errorMessage=a.message||"خطا در دریافت کاربران"}}async function E(){try{const{data:e,error:a}=await B(T("/base/approval-flow",{query:{"filter[request_type_id]":1}}));if(a.value)throw a.value;w.value=e.value.data}catch(e){console.error("Error fetching approval flows:",e),o.hasError=!0,o.errorMessage=e.message||"خطا در دریافت رده تأییدیه‌ها"}}async function J(){const e=s.value.length===0,a=(e?[null]:s.value).map((r,p)=>({requester_user_id:u.value.group?null:u.value.data.id,requester_position_id:u.value.group?u.value.groupValue.rayvarz_id:null,requester_center_id:u.value.group?u.value.parent.groupValue.rayvarz_id:null,approver_user_id:e||r.group?null:r.data.id,approver_position_id:e?null:r.group?r.groupValue.rayvarz_id:null,approver_center_id:e?null:r.group?r.parent.groupValue.rayvarz_id:null,priority:p+1,request_type_id:1}));i.updateApprovalFlow=!0;try{await ne("/base/approval-flow/update",{method:"POST",body:{approvalFlows:a},onResponseError({response:r}){o.hasError=!0,o.errorMessage=r._data.message||"خطا در بروزرسانی رده تأییدیه‌ها"}})}catch(r){console.error(r)}finally{z(),await E(),i.updateApprovalFlow=!1,g.value="view"}}return z(),[b,h]=re(()=>E()),await b,h(),oe(g,e=>{e==="view"?(t.value.setGridOption("rowSelection",{...A.value,mode:"singleRow"}),t.value.deselectAll(),t.value.setNodesSelected({nodes:[t.value.getRowNode(u.value.id)],newValue:!0})):e==="edit"&&(t.value.setGridOption("rowSelection",{...A.value,mode:"multiRow"}),t.value.deselectAll(),t.value.setNodesSelected({nodes:s.value.map(a=>t.value.getRowNode(a.id)),newValue:!0}))}),(e,a)=>{const r=te("AgGridVue");return m(),N(ue,{class:"app-layout"},{default:n(()=>[_(se,{modelValue:l(o).hasError,"onUpdate:modelValue":a[0]||(a[0]=p=>l(o).hasError=p),timeout:2e3,location:"center",variant:"outlined",color:"error"},{default:n(()=>[y(V(l(o).errorMessage),1)]),_:1},8,["modelValue"]),j("div",null,[l(d).length>0||l(g)==="edit"?(m(),N(de,{key:0,requester:l(u),"approval-flow":l(s),mode:l(g),loading:l(i).updateApprovalFlow,onEdit:a[1]||(a[1]=p=>g.value="edit"),onSave:J,onCancel:a[2]||(a[2]=p=>g.value="view")},null,8,["requester","approval-flow","mode","loading"])):k("",!0)]),j("section",pe,[_(r,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":l(L),"get-row-id":l(O),"enable-rtl":"","row-numbers":"",pagination:"","group-display-type":"multipleColumns","auto-group-column-def":l(U),"cell-selection":"","row-selection":l(A),theme:l(I),onGridReady:M,onSelectionChanged:H},null,8,["column-defs","get-row-id","auto-group-column-def","row-selection","theme"])])]),_:1})}}},qe=ee(ve,[["__scopeId","data-v-bb41af2a"]]);export{qe as default};
