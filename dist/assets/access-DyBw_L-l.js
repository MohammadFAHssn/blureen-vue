import{_ as H}from"./DialogCloseBtn-CHUkvqwO.js";import{V as K,a as W,b as X,d as Z}from"./VCard-17K4x68G.js";/* empty css              */import{au as ee,a5 as te,ap as se,aM as ae,aa as oe,b as l,J as le,y as ie,aQ as re,aT as ne,ac as ce,r as p,Y as A,w as de,f as _,o as m,e as i,m as b,c as D,d as J,x as U,F as $,i as B,n as s,a2 as ue,v as M,a1 as N,bq as me,al as fe,M as pe,bJ as F,bL as ge,a as Ve}from"./index-Cv5lpMoC.js";import{V as he}from"./VRow-l4u1Uxae.js";import{V as G}from"./VCol-BrQu83Ip.js";import{V as _e}from"./VTextField-B8uhBsMQ.js";import{V as P}from"./VDivider-BbA7I2Gx.js";import{V as ve}from"./VSkeletonLoader-DAJTykY0.js";import{V as ye,a as be,b as Ce}from"./VList-CLhvF6sc.js";import{V as we}from"./VDialog-KuDNgpdx.js";import{u as ke,V as Re}from"./VLayout-DOHWz4K2.js";import{u as T}from"./useApi-C79904eT.js";import{c as q}from"./createUrl-DpnoEnQl.js";import{$ as De}from"./api-D7L6QCgv.js";import{i as z}from"./helpers-4BKJjDfb.js";import{V as $e}from"./VSnackbar-Cvu8d9kO.js";import"./createSimpleFunctional-Yzr4tF6x.js";import"./VCardText-BlDpg-ll.js";import"./VCounter-qsWo-RDi.js";import"./VField-E_86BP7W.js";import"./VLabel-CvTAAgKI.js";import"./form-BpfsWwaW.js";import"./forwardRefs-BYSXgJht.js";import"./VInput-DcHqf4MH.js";import"./VOverlay-Dldupupz.js";import"./dialog-transition-Bx9V9skK.js";import"./useLogout-CSv5cDty.js";const Ae=te({fluid:{type:Boolean,default:!1},...ce(),...ne(),...re()},"VContainer"),Ue=ee()({name:"VContainer",props:Ae(),setup(u,C){let{slots:g}=C;const{rtlClasses:a}=se(),{dimensionStyles:V}=ae(u);return oe(()=>l(u.tag,{class:ie(["v-container",{"v-container--fluid":u.fluid},a.value,u.class]),style:le([V.value,u.style])},g)),{}}}),xe={class:"text-h6 mb-2 text-wrap"},Ee={__name:"RelationManagerDialog",props:{isDialogVisible:{type:Boolean,required:!0},isFetchItemsPending:{type:Boolean,required:!0},items:{type:Array,required:!0},selected:{type:Array,required:!0},title:{type:String,required:!0},loading:{type:Boolean,required:!0}},emits:["update:isDialogVisible","change"],setup(u,{emit:C}){const g=u,a=C;function V(n){a("update:isDialogVisible",n)}const v=g.items,f=p(),h=p(""),r=p(v.filter(n=>g.selected.some(c=>c.id===n.id))),w=A(()=>r.value.length===v.length),x=A(()=>{const n=h.value.toLowerCase();return n?v.filter(c=>c.name.toLowerCase().includes(n)):v}),E=A(()=>{const n=[];for(const c of r.value)n.push(c);return n});de(r,()=>{h.value=""});function S(){a("change",r.value)}return(n,c)=>{const k=H;return m(),_(we,{"model-value":g.isDialogVisible,width:n.$vuetify.display.smAndDown?"auto":800,"onUpdate:modelValue":V},{default:i(()=>[l(k,{onClick:c[0]||(c[0]=o=>n.$emit("update:isDialogVisible",!1))}),l(K,null,{default:i(()=>[l(W,{class:"text-center"},{default:i(()=>[l(X,null,{default:i(()=>[J("h6",xe,U(g.title),1)]),_:1})]),_:1}),l(Ue,null,{default:i(()=>[l(he,{align:"center",justify:"start"},{default:i(()=>[(m(!0),D($,null,B(s(E),(o,R)=>(m(),_(G,{key:o.id,class:"py-1 pe-0",cols:"auto"},{default:i(()=>[l(ue,{disabled:u.loading,closable:"","onClick:close":L=>s(r).splice(R,1)},{default:i(()=>[o.icon?(m(),_(N,{key:0,icon:o.icon,start:""},null,8,["icon"])):b("",!0),M(" "+U(o.name),1)]),_:2},1032,["disabled","onClick:close"])]),_:2},1024))),128)),s(w)?b("",!0):(m(),_(G,{key:0,cols:"12"},{default:i(()=>[l(_e,{ref_key:"searchField",ref:f,modelValue:s(h),"onUpdate:modelValue":c[1]||(c[1]=o=>me(h)?h.value=o:null),label:"Search","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1}))]),_:1})]),_:1}),s(w)?b("",!0):(m(),_(P,{key:0})),u.isFetchItemsPending?(m(),D($,{key:1},B(3,o=>l(ve,{key:o,type:"list-item"})),64)):b("",!0),l(ye,null,{default:i(()=>[(m(!0),D($,null,B(s(x),o=>(m(),D($,null,[s(r).includes(o)?b("",!0):(m(),_(be,{key:o.id,disabled:u.loading,onClick:R=>s(r).push(o)},{prepend:i(()=>[o.icon?(m(),_(N,{key:0,disabled:u.loading,icon:o.icon},null,8,["disabled","icon"])):b("",!0)]),default:i(()=>[l(Ce,{textContent:U(o.name)},null,8,["textContent"])]),_:2},1032,["disabled","onClick"]))],64))),256))]),_:1}),l(P),l(Z,null,{default:i(()=>[l(fe,{loading:u.loading,color:"purple",variant:"text",onClick:S},{default:i(()=>c[2]||(c[2]=[M(" ذخیره ",-1)])),_:1,__:[2]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value","width"])}}},Se={class:"ag-grid-sec"},Ie={__name:"access",async setup(u){let C,g;const a=F({hasError:!1,errorMessage:"",isEditAccessDialogVisible:!1}),V=p([]),v=p([]),f=p([]),h=p([]),r=F({fetchingRoles:!1,updatingUserRoles:!1}),{theme:w}=ke(),x=p(null);function E(t){x.value=t.api}const S=p({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:t=>t.field==="user"}),n=p([{headerName:"کاربر",field:"user"},{headerName:"نقش",field:"role"},{headerName:"مجوز",field:"permission"}]),c=p({flex:1,enableRowGroup:!0,rowGroup:!0,filter:!0});function k(t){t.node.isSelected()||(t.api.deselectAll(),t.node.setSelected(!0));const e=t.api.getSelectedNodes(),d=[];return e.forEach(y=>{d.push(y.groupValue.split("-")[0].trim())}),d.length?[{icon:'<i class="tabler tabler-edit" style="font-size: 18px;"></i>',name:"ویرایش دسترسی",action:()=>{L(d),j(),a.isEditAccessDialogVisible=!0}},"separator",...t.defaultItems]:[...t.defaultItems]}async function o(){try{const{data:t,error:e}=await T(q("/base/user?fields[users]=id,personnel_code,first_name,last_name&fields[roles]=id,name&fields[roles.permissions]=name&include=roles.permissions"));if(e.value)throw e.value;V.value=t.value.data}catch(t){console.error("Error fetching user access:",t),a.hasError=!0,a.errorMessage="خطا در دریافت دسترسی کاربران"}}async function R(){r.fetchingRoles=!0;try{const{data:t,error:e}=await T(q("/base/role?include=permissions"));if(r.fetchingRoles=!1,e.value)throw e.value;v.value=t.value.data}catch(t){console.error("Error fetching roles:",t),a.hasError=!0,a.errorMessage="خطا در دریافت لیست نقش‌ها"}}function L(t){f.value=[],t.forEach(e=>{f.value.push(V.value.find(d=>d.personnel_code===e))})}function j(){f.value.length>1?h.value=[]:h.value=f.value[0].roles.map(t=>({id:t.id,name:t.name}))}async function O(t){r.updatingUserRoles=!0;try{await De("/base/user-role/update",{method:"POST",body:{userId:f.value[0].id,roleIds:t.map(e=>e.id)},onResponseError({response:e}){r.updatingUserRoles=!1,a.hasError=!0,a.errorMessage=e._data.message||"خطا در بروزرسانی دسترسی‌ها"}}),r.updatingUserRoles=!1,a.isEditAccessDialogVisible=!1,Q(t)}catch(e){console.error(e)}}function Q(t){V.value=V.value.map(e=>(e.id===f.value[0].id&&(e.roles=t.map(d=>v.value.find(y=>y.id===d.id))),e))}R(),[C,g]=ge(()=>o()),await C,g();const Y=A(()=>{const t=[];return V.value.map(e=>{z(e.roles)&&t.push({user:`${e.personnel_code} - ${e.first_name} ${e.last_name}`}),e.roles.map(d=>{z(d.permissions)&&t.push({user:`${e.personnel_code} - ${e.first_name} ${e.last_name}`,role:d.name}),d.permissions.map(y=>t.push({user:`${e.personnel_code} - ${e.first_name} ${e.last_name}`,role:d.name,permission:y.name}))})}),t});return(t,e)=>{const d=Ee,y=Ve("AgGridVue");return m(),_(Re,{class:"app-layout"},{default:i(()=>[l($e,{modelValue:s(a).hasError,"onUpdate:modelValue":e[0]||(e[0]=I=>s(a).hasError=I),timeout:2e3,location:"center",variant:"outlined",color:"error"},{default:i(()=>[M(U(s(a).errorMessage),1)]),_:1},8,["modelValue"]),s(a).isEditAccessDialogVisible?(m(),_(d,{key:0,"is-dialog-visible":s(a).isEditAccessDialogVisible,"onUpdate:isDialogVisible":e[1]||(e[1]=I=>s(a).isEditAccessDialogVisible=I),title:`دسترسی ${s(f).length>1?"کاربران":`${s(f)[0].first_name} ${s(f)[0].last_name} (${s(f)[0].personnel_code})`}`,"is-fetch-items-pending":s(r).fetchingRoles,items:s(v),selected:s(h),loading:s(r).updatingUserRoles,onChange:O},null,8,["is-dialog-visible","title","is-fetch-items-pending","items","selected","loading"])):b("",!0),J("section",Se,[l(y,{theme:s(w),style:{"block-size":"100%","inline-size":"100%"},"column-defs":s(n),"row-data":s(Y),"default-col-def":s(c),"row-numbers":"","cell-selection":"","row-selection":s(S),"enable-rtl":"",pagination:"","row-group-panel-show":"always","get-context-menu-items":k,onGridReady:E},null,8,["theme","column-defs","row-data","default-col-def","row-selection"])])]),_:1})}}},nt=pe(Ie,[["__scopeId","data-v-5cc94083"]]);export{nt as default};
