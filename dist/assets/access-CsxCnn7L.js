import{_ as H}from"./DialogCloseBtn-CrHa8mi5.js";import{V as K,a as W,b as X,c as Z}from"./VCard-Bv1t2-PZ.js";/* empty css              */import{au as ee,a5 as te,ap as se,aM as ae,aa as oe,b as l,J as le,y as ie,aQ as ne,aT as re,ac as ce,r as p,Y as A,w as de,f as v,o as m,e as i,m as b,c as D,d as J,x as U,F as $,i as B,n as s,a2 as ue,v as M,a1 as F,bq as me,al as fe,M as pe,bJ as G,c9 as ge,a as he}from"./index-s0RY1Vh3.js";import{V as Ve,a as L}from"./VRow-CuiommJz.js";import{V as ve}from"./VTextField-4PrPEu9P.js";import{V as P}from"./VDivider-BEEqMFkt.js";import{V as ye}from"./VSkeletonLoader-CLCMncX_.js";import{V as _e,a as be,b as Ce}from"./VList-DOjfcX1c.js";import{V as we}from"./VDialog-BTGPZhJ3.js";import{u as ke,V as Re}from"./VLayout-D2KcRgBG.js";import{u as T}from"./useApi-C9zakE7v.js";import{c as q}from"./createUrl-CQu6RZtU.js";import{$ as De}from"./api-DmXPaD3K.js";import{i as z}from"./helpers-4BKJjDfb.js";import{V as $e}from"./VSnackbar-Bs99S9L5.js";import"./createSimpleFunctional-BiI6uwdY.js";import"./VCardText-Bt9r9Lfo.js";import"./VCounter-weFYZeBn.js";import"./VField-D0InP9x9.js";import"./VLabel-0aTGfkIp.js";import"./form-CYgMbtoI.js";import"./VOverlay-C-ORRKTC.js";import"./VInput-BcKA6MXF.js";import"./dialog-transition-4Ypcw0oE.js";import"./useLogout-C4sbuR-f.js";const Ae=te({fluid:{type:Boolean,default:!1},...ce(),...re(),...ne()},"VContainer"),Ue=ee()({name:"VContainer",props:Ae(),setup(u,C){let{slots:g}=C;const{rtlClasses:a}=se(),{dimensionStyles:h}=ae(u);return oe(()=>l(u.tag,{class:ie(["v-container",{"v-container--fluid":u.fluid},a.value,u.class]),style:le([h.value,u.style])},g)),{}}}),Ee={class:"text-h6 mb-2 text-wrap"},Se={__name:"RelationManagerDialog",props:{isDialogVisible:{type:Boolean,required:!0},isFetchItemsPending:{type:Boolean,required:!0},items:{type:Array,required:!0},selected:{type:Array,required:!0},title:{type:String,required:!0},loading:{type:Boolean,required:!0}},emits:["update:isDialogVisible","change"],setup(u,{emit:C}){const g=u,a=C;function h(r){a("update:isDialogVisible",r)}const y=g.items,f=p(),V=p(""),n=p(y.filter(r=>g.selected.some(c=>c.id===r.id))),w=A(()=>n.value.length===y.length),E=A(()=>{const r=V.value.toLowerCase();return r?y.filter(c=>c.name.toLowerCase().includes(r)):y}),S=A(()=>{const r=[];for(const c of n.value)r.push(c);return r});de(n,()=>{V.value=""});function x(){a("change",n.value)}return(r,c)=>{const k=H;return m(),v(we,{"model-value":g.isDialogVisible,width:r.$vuetify.display.smAndDown?"auto":800,"onUpdate:modelValue":h},{default:i(()=>[l(k,{onClick:c[0]||(c[0]=o=>r.$emit("update:isDialogVisible",!1))}),l(K,null,{default:i(()=>[l(W,{class:"text-center"},{default:i(()=>[l(X,null,{default:i(()=>[J("h6",Ee,U(g.title),1)]),_:1})]),_:1}),l(Ue,null,{default:i(()=>[l(Ve,{align:"center",justify:"start"},{default:i(()=>[(m(!0),D($,null,B(s(S),(o,R)=>(m(),v(L,{key:o.id,class:"py-1 pe-0",cols:"auto"},{default:i(()=>[l(ue,{disabled:u.loading,closable:"","onClick:close":N=>s(n).splice(R,1)},{default:i(()=>[o.icon?(m(),v(F,{key:0,icon:o.icon,start:""},null,8,["icon"])):b("",!0),M(" "+U(o.name),1)]),_:2},1032,["disabled","onClick:close"])]),_:2},1024))),128)),s(w)?b("",!0):(m(),v(L,{key:0,cols:"12"},{default:i(()=>[l(ve,{ref_key:"searchField",ref:f,modelValue:s(V),"onUpdate:modelValue":c[1]||(c[1]=o=>me(V)?V.value=o:null),label:"Search","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1}))]),_:1})]),_:1}),s(w)?b("",!0):(m(),v(P,{key:0})),u.isFetchItemsPending?(m(),D($,{key:1},B(3,o=>l(ye,{key:o,type:"list-item"})),64)):b("",!0),l(_e,null,{default:i(()=>[(m(!0),D($,null,B(s(E),o=>(m(),D($,null,[s(n).includes(o)?b("",!0):(m(),v(be,{key:o.id,disabled:u.loading,onClick:R=>s(n).push(o)},{prepend:i(()=>[o.icon?(m(),v(F,{key:0,disabled:u.loading,icon:o.icon},null,8,["disabled","icon"])):b("",!0)]),default:i(()=>[l(Ce,{textContent:U(o.name)},null,8,["textContent"])]),_:2},1032,["disabled","onClick"]))],64))),256))]),_:1}),l(P),l(Z,null,{default:i(()=>[l(fe,{loading:u.loading,color:"purple",variant:"text",onClick:x},{default:i(()=>[...c[2]||(c[2]=[M(" ذخیره ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value","width"])}}},xe={class:"ag-grid-sec"},Ie={__name:"access",async setup(u){let C,g;const a=G({hasError:!1,errorMessage:"",isEditAccessDialogVisible:!1}),h=p([]),y=p([]),f=p([]),V=p([]),n=G({fetchingRoles:!1,updatingUserRoles:!1}),{theme:w}=ke(),E=p(null);function S(t){E.value=t.api}const x=p({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:t=>t.field==="user"}),r=p([{headerName:"کاربر",field:"user"},{headerName:"نقش",field:"role"},{headerName:"مجوز",field:"permission"}]),c=p({enableRowGroup:!0,rowGroup:!0});function k(t){t.node.isSelected()||(t.api.deselectAll(),t.node.setSelected(!0));const e=t.api.getSelectedNodes(),d=[];return e.forEach(_=>{d.push(_.groupValue.split("-")[0].trim())}),d.length?[{icon:'<i class="tabler tabler-edit" style="font-size: 18px;"></i>',name:"ویرایش دسترسی",action:()=>{N(d),j(),a.isEditAccessDialogVisible=!0}},"separator",...t.defaultItems]:[...t.defaultItems]}async function o(){try{const{data:t,error:e}=await T(q("/base/user?fields[users]=id,personnel_code,first_name,last_name&fields[roles]=id,name&fields[roles.permissions]=name&include=roles.permissions"));if(e.value)throw e.value;h.value=t.value.data}catch(t){console.error("Error fetching user access:",t),a.hasError=!0,a.errorMessage="خطا در دریافت دسترسی کاربران"}}async function R(){n.fetchingRoles=!0;try{const{data:t,error:e}=await T(q("/base/role?include=permissions"));if(n.fetchingRoles=!1,e.value)throw e.value;y.value=t.value.data}catch(t){console.error("Error fetching roles:",t),a.hasError=!0,a.errorMessage="خطا در دریافت لیست نقش‌ها"}}function N(t){f.value=[],t.forEach(e=>{f.value.push(h.value.find(d=>d.personnel_code===e))})}function j(){f.value.length>1?V.value=[]:V.value=f.value[0].roles.map(t=>({id:t.id,name:t.name}))}async function O(t){n.updatingUserRoles=!0;try{await De("/base/user-role/update",{method:"POST",body:{userId:f.value[0].id,roleIds:t.map(e=>e.id)},onResponseError({response:e}){n.updatingUserRoles=!1,a.hasError=!0,a.errorMessage=e._data.message||"خطا در بروزرسانی دسترسی‌ها"}}),n.updatingUserRoles=!1,a.isEditAccessDialogVisible=!1,Q(t)}catch(e){console.error(e)}}function Q(t){h.value=h.value.map(e=>(e.id===f.value[0].id&&(e.roles=t.map(d=>y.value.find(_=>_.id===d.id))),e))}R(),[C,g]=ge(()=>o()),await C,g();const Y=A(()=>{const t=[];return h.value.map(e=>{z(e.roles)&&t.push({user:`${e.personnel_code} - ${e.first_name} ${e.last_name}`}),e.roles.map(d=>{z(d.permissions)&&t.push({user:`${e.personnel_code} - ${e.first_name} ${e.last_name}`,role:d.name}),d.permissions.map(_=>t.push({user:`${e.personnel_code} - ${e.first_name} ${e.last_name}`,role:d.name,permission:_.name}))})}),t});return(t,e)=>{const d=Se,_=he("AgGridVue");return m(),v(Re,{class:"app-layout"},{default:i(()=>[l($e,{modelValue:s(a).hasError,"onUpdate:modelValue":e[0]||(e[0]=I=>s(a).hasError=I),timeout:2e3,location:"center",variant:"outlined",color:"error"},{default:i(()=>[M(U(s(a).errorMessage),1)]),_:1},8,["modelValue"]),s(a).isEditAccessDialogVisible?(m(),v(d,{key:0,"is-dialog-visible":s(a).isEditAccessDialogVisible,"onUpdate:isDialogVisible":e[1]||(e[1]=I=>s(a).isEditAccessDialogVisible=I),title:`دسترسی ${s(f).length>1?"کاربران":`${s(f)[0].first_name} ${s(f)[0].last_name} (${s(f)[0].personnel_code})`}`,"is-fetch-items-pending":s(n).fetchingRoles,items:s(y),selected:s(V),loading:s(n).updatingUserRoles,onChange:O},null,8,["is-dialog-visible","title","is-fetch-items-pending","items","selected","loading"])):b("",!0),J("section",xe,[l(_,{theme:s(w),style:{"block-size":"100%","inline-size":"100%"},"column-defs":s(r),"row-data":s(Y),"default-col-def":s(c),"row-numbers":"","cell-selection":"","row-selection":s(x),"enable-rtl":"",pagination:"","row-group-panel-show":"always","get-context-menu-items":k,onGridReady:S},null,8,["theme","column-defs","row-data","default-col-def","row-selection"])])]),_:1})}}},it=pe(Ie,[["__scopeId","data-v-751a36ec"]]);export{it as default};
