import{_ as Z}from"./DialogCloseBtn-uCFNTSMG.js";import{V as H,a as K,b as Q,d as X}from"./VCard-DXyMAqZ9.js";/* empty css              */import{av as ee,a6 as se,aq as te,aS as ae,ab as oe,b as l,J as le,y as ie,aW as ne,aZ as re,ad as de,r as p,Y as A,w as ce,f as v,o as m,e as i,m as b,c as D,d as j,x as S,F as $,i as B,n as t,a2 as ue,v as L,a1 as N,bq as me,am as fe,M as pe,bL as q,c8 as ge,a as he}from"./index-CTn1zpMl.js";import{V as Ve,a as F}from"./VRow-CET45aX5.js";import{V as ve}from"./VTextField-C9Fw6r4W.js";import{V as G}from"./VDivider-BaxVbuHx.js";import{V as ye}from"./VSkeletonLoader-AERLxjy1.js";import{V as _e,a as be,b as Ce}from"./VList-BL8r1icQ.js";import{V as we}from"./VDialog-4BFANWXB.js";import{u as ke,V as Re}from"./VLayout-DP4UPJQH.js";import{u as P}from"./useApi-DkrqySTn.js";import{c as T}from"./createUrl-Ci1yB_A5.js";import{$ as De}from"./api-CIiSBdAt.js";import{i as z}from"./helpers-4BKJjDfb.js";import{V as $e}from"./VSnackbar-BIzAdlyD.js";import"./createSimpleFunctional-BLD9Lq1U.js";import"./VCardText-Bf9VcR3P.js";import"./VCounter-BtfMPxqe.js";import"./VField-ByrHga6n.js";import"./VOverlay-D193HQRA.js";import"./dialog-transition-CbHg9h4n.js";import"./useLogout-cMquD6Tt.js";const Ae=se({fluid:{type:Boolean,default:!1},...de(),...re(),...ne()},"VContainer"),Se=ee()({name:"VContainer",props:Ae(),setup(u,C){let{slots:g}=C;const{rtlClasses:a}=te(),{dimensionStyles:h}=ae(u);return oe(()=>l(u.tag,{class:ie(["v-container",{"v-container--fluid":u.fluid},a.value,u.class]),style:le([h.value,u.style])},g)),{}}}),Ue={class:"text-h6 mb-2 text-wrap"},Ee={__name:"RelationManagerDialog",props:{isDialogVisible:{type:Boolean,required:!0},isFetchItemsPending:{type:Boolean,required:!0},items:{type:Array,required:!0},selected:{type:Array,required:!0},title:{type:String,required:!0},loading:{type:Boolean,required:!0}},emits:["update:isDialogVisible","change"],setup(u,{emit:C}){const g=u,a=C;function h(r){a("update:isDialogVisible",r)}const y=g.items,f=p(),V=p(""),n=p(y.filter(r=>g.selected.some(d=>d.id===r.id))),w=A(()=>n.value.length===y.length),U=A(()=>{const r=V.value.toLowerCase();return r?y.filter(d=>d.name.toLowerCase().includes(r)):y}),E=A(()=>{const r=[];for(const d of n.value)r.push(d);return r});ce(n,()=>{V.value=""});function x(){a("change",n.value)}return(r,d)=>{const k=Z;return m(),v(we,{"model-value":g.isDialogVisible,width:r.$vuetify.display.smAndDown?"auto":800,"onUpdate:modelValue":h},{default:i(()=>[l(k,{onClick:d[0]||(d[0]=o=>r.$emit("update:isDialogVisible",!1))}),l(H,null,{default:i(()=>[l(K,{class:"text-center"},{default:i(()=>[l(Q,null,{default:i(()=>[j("h6",Ue,S(g.title),1)]),_:1})]),_:1}),l(Se,null,{default:i(()=>[l(Ve,{align:"center",justify:"start"},{default:i(()=>[(m(!0),D($,null,B(t(E),(o,R)=>(m(),v(F,{key:o.id,class:"py-1 pe-0",cols:"auto"},{default:i(()=>[l(ue,{disabled:u.loading,closable:"","onClick:close":M=>t(n).splice(R,1)},{default:i(()=>[o.icon?(m(),v(N,{key:0,icon:o.icon,start:""},null,8,["icon"])):b("",!0),L(" "+S(o.name),1)]),_:2},1032,["disabled","onClick:close"])]),_:2},1024))),128)),t(w)?b("",!0):(m(),v(F,{key:0,cols:"12"},{default:i(()=>[l(ve,{ref_key:"searchField",ref:f,modelValue:t(V),"onUpdate:modelValue":d[1]||(d[1]=o=>me(V)?V.value=o:null),label:"Search","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1}))]),_:1})]),_:1}),t(w)?b("",!0):(m(),v(G,{key:0})),u.isFetchItemsPending?(m(),D($,{key:1},B(3,o=>l(ye,{key:o,type:"list-item"})),64)):b("",!0),l(_e,null,{default:i(()=>[(m(!0),D($,null,B(t(U),o=>(m(),D($,null,[t(n).includes(o)?b("",!0):(m(),v(be,{key:o.id,disabled:u.loading,onClick:R=>t(n).push(o)},{prepend:i(()=>[o.icon?(m(),v(N,{key:0,disabled:u.loading,icon:o.icon},null,8,["disabled","icon"])):b("",!0)]),default:i(()=>[l(Ce,{textContent:S(o.name)},null,8,["textContent"])]),_:2},1032,["disabled","onClick"]))],64))),256))]),_:1}),l(G),l(X,null,{default:i(()=>[l(fe,{loading:u.loading,color:"purple",variant:"text",onClick:x},{default:i(()=>[...d[2]||(d[2]=[L(" ذخیره ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value","width"])}}},xe={class:"ag-grid-sec"},Ie={__name:"access",async setup(u){let C,g;const a=q({hasError:!1,errorMessage:"",isEditAccessDialogVisible:!1}),h=p([]),y=p([]),f=p([]),V=p([]),n=q({fetchingRoles:!1,updatingUserRoles:!1}),{theme:w}=ke(),U=p(null);function E(e){U.value=e.api}const x=p({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:e=>e.field==="user"}),r=p([{headerName:"کاربر",field:"user"},{headerName:"نقش",field:"role"},{headerName:"مجوز",field:"permission"}]),d=p({enableRowGroup:!0,rowGroup:!0});function k(e){e.node.isSelected()||(e.api.deselectAll(),e.node.setSelected(!0));const s=e.api.getSelectedNodes(),c=[];return s.forEach(_=>{c.push(_.groupValue.split("-")[0].trim())}),c.length?[{icon:'<i class="tabler tabler-edit" style="font-size: 18px;"></i>',name:"ویرایش دسترسی",action:()=>{M(c),J(),a.isEditAccessDialogVisible=!0}},"separator",...e.defaultItems]:[...e.defaultItems]}async function o(){try{const{data:e,error:s}=await P(T("/base/user?fields[users]=id,personnel_code,first_name,last_name&fields[roles]=id,name&fields[roles.permissions]=name&include=roles.permissions"));if(s.value)throw s.value;h.value=e.value.data}catch(e){console.error("Error fetching user access:",e),a.hasError=!0,a.errorMessage=e.message||"خطا در دریافت دسترسی کاربران"}}async function R(){n.fetchingRoles=!0;try{const{data:e,error:s}=await P(T("/base/role?include=permissions"));if(n.fetchingRoles=!1,s.value)throw s.value;y.value=e.value.data}catch(e){console.error("Error fetching roles:",e),a.hasError=!0,a.errorMessage=e.message||"خطا در دریافت لیست نقش‌ها"}}function M(e){f.value=[],e.forEach(s=>{f.value.push(h.value.find(c=>c.personnel_code===s))})}function J(){f.value.length>1?V.value=[]:V.value=f.value[0].roles.map(e=>({id:e.id,name:e.name}))}async function O(e){n.updatingUserRoles=!0;try{await De("/base/user-role/update",{method:"POST",body:{userId:f.value[0].id,roleIds:e.map(s=>s.id)},onResponseError({response:s}){n.updatingUserRoles=!1,a.hasError=!0,a.errorMessage=s._data.message||"خطا در بروزرسانی دسترسی‌ها"}}),n.updatingUserRoles=!1,a.isEditAccessDialogVisible=!1,W(e)}catch(s){console.error(s)}}function W(e){h.value=h.value.map(s=>(s.id===f.value[0].id&&(s.roles=e.map(c=>y.value.find(_=>_.id===c.id))),s))}R(),[C,g]=ge(()=>o()),await C,g();const Y=A(()=>{const e=[];return h.value.map(s=>{z(s.roles)&&e.push({user:`${s.personnel_code} - ${s.first_name} ${s.last_name}`}),s.roles.map(c=>{z(c.permissions)&&e.push({user:`${s.personnel_code} - ${s.first_name} ${s.last_name}`,role:c.name}),c.permissions.map(_=>e.push({user:`${s.personnel_code} - ${s.first_name} ${s.last_name}`,role:c.name,permission:_.name}))})}),e});return(e,s)=>{const c=Ee,_=he("AgGridVue");return m(),v(Re,{class:"app-layout"},{default:i(()=>[l($e,{modelValue:t(a).hasError,"onUpdate:modelValue":s[0]||(s[0]=I=>t(a).hasError=I),timeout:2e3,location:"center",variant:"outlined",color:"error"},{default:i(()=>[L(S(t(a).errorMessage),1)]),_:1},8,["modelValue"]),t(a).isEditAccessDialogVisible?(m(),v(c,{key:0,"is-dialog-visible":t(a).isEditAccessDialogVisible,"onUpdate:isDialogVisible":s[1]||(s[1]=I=>t(a).isEditAccessDialogVisible=I),title:`دسترسی ${t(f).length>1?"کاربران":`${t(f)[0].first_name} ${t(f)[0].last_name} (${t(f)[0].personnel_code})`}`,"is-fetch-items-pending":t(n).fetchingRoles,items:t(y),selected:t(V),loading:t(n).updatingUserRoles,onChange:O},null,8,["is-dialog-visible","title","is-fetch-items-pending","items","selected","loading"])):b("",!0),j("section",xe,[l(_,{theme:t(w),style:{"block-size":"100%","inline-size":"100%"},"column-defs":t(r),"row-data":t(Y),"default-col-def":t(d),"row-numbers":"","cell-selection":"","row-selection":t(x),"enable-rtl":"",pagination:"","row-group-panel-show":"always","get-context-menu-items":k,onGridReady:E},null,8,["theme","column-defs","row-data","default-col-def","row-selection"])])]),_:1})}}},as=pe(Ie,[["__scopeId","data-v-b4417713"]]);export{as as default};
