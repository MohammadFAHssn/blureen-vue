import{b as le,c as se,V as J}from"./VCard-CX4UpRmD.js";import{f as w,o as p,e as i,b as f,v as q,c as F,F as x,i as P,a2 as E,x as A,m as k,bW as ie,am as S,a1 as U,M as ue,bH as L,r as y,a7 as O,bI as H,w as ne,a as de,d as W,n as l,ci as pe,bq as ce,bL as ve}from"./index-CxBCniRz.js";import{V as K}from"./VCardText-BVXiE7iR.js";import{u as fe}from"./useAGGridTheme-L2rmlC2O.js";import{u as G}from"./useApi-jnKEpwZA.js";import{c as $}from"./createUrl-BEzvRIlS.js";import{$ as me}from"./api-CctPY7dA.js";import{V as ge}from"./VSnackbar-zL0lJxOR.js";import{V as ye}from"./VLayout-DlnIsn08.js";import"./createSimpleFunctional-BbzySe_P.js";import"./useLogout-CUJN8KZ_.js";import"./VOverlay-CLFRDIcR.js";const we={__name:"ApprovalFlow",props:{requesters:{required:!0},approvalFlow:{type:Array,required:!0},mode:{type:String,required:!0},loading:{type:Boolean,default:!0}},setup(_){const N=_;return(h,r)=>(p(),w(J,{class:"mb-3",color:_.mode==="edit"?"yellow-lighten-4":""},{default:i(()=>[f(le,{class:"text-wrap"},{default:i(()=>[r[3]||(r[3]=q(" رده تأییدیه‌های ",-1)),(p(!0),F(x,null,P(N.requesters,s=>(p(),w(E,{key:s.id,variant:"outlined",color:"info",class:"ml-3 mb-3"},{default:i(()=>{var V,b,g;return[q(A((V=s.data)==null?void 0:V.firstName)+" "+A((b=s.data)==null?void 0:b.lastName)+" "+A((g=s.groupValue)==null?void 0:g.name),1)]}),_:2},1024))),128))]),_:1}),f(K,{class:"d-flex align-center pa-5"},{default:i(()=>[(p(!0),F(x,null,P(N.approvalFlow,(s,V)=>(p(),F("div",{key:V},[f(E,{color:"primary"},ie({default:i(()=>{var b,g,c;return[q(A((b=s.data)==null?void 0:b.firstName)+" "+A((g=s.data)==null?void 0:g.lastName)+" "+A((c=s.groupValue)==null?void 0:c.name)+" ",1)]}),_:2},[_.mode==="edit"?{name:"append",fn:i(()=>[f(S,{class:"mr-2",size:"20",icon:"",onClick:b=>h.$emit("removeApprover",V)},{default:i(()=>[f(U,{icon:"tabler-x",size:"15"})]),_:2},1032,["onClick"])]),key:"0"}:void 0]),1024),V!==N.approvalFlow.length-1?(p(),w(E,{key:0,variant:"text",color:"primary"},{default:i(()=>[f(U,{icon:"tabler-chevron-left"})]),_:1})):k("",!0)]))),128))]),_:1}),f(se,null,{default:i(()=>[_.mode==="edit"?(p(),w(S,{key:0,color:"success",loading:_.loading,onClick:r[0]||(r[0]=s=>h.$emit("save"))},{default:i(()=>[...r[4]||(r[4]=[q(" ذخیره ",-1)])]),_:1},8,["loading"])):k("",!0),_.mode==="edit"?(p(),w(S,{key:1,color:"error",disabled:_.loading,onClick:r[1]||(r[1]=s=>h.$emit("cancel"))},{default:i(()=>[...r[5]||(r[5]=[q(" بستن ",-1)])]),_:1},8,["disabled"])):k("",!0),_.mode==="view"?(p(),w(S,{key:2,color:"warning",onClick:r[2]||(r[2]=s=>h.$emit("edit"))},{default:i(()=>[...r[6]||(r[6]=[q(" ویرایش ",-1)])]),_:1})):k("",!0)]),_:1})]),_:1},8,["color"]))}},_e={style:{"block-size":"100%"}},he={__name:"organization-chart",async setup(_){let N,h;const r=L({hasError:!1,errorMessage:""}),s=L({updateApprovalFlow:!1,changeRequestType:!1}),V=y([]),b=y([]),g=y([]),c=y([]),m=y("view"),v=O(null),n=y([]),R=y([]),u=O(0),{theme:Q}=fe();function X(a){v.value=a.api,v.value.setGridOption("rowData",M())}const Y=y([{headerName:"محل کار",field:"workplace",rowGroup:!0,hide:!0},{headerName:"منطقه کاری",field:"workArea",rowGroup:!0,hide:!0},{headerName:"مرکز هزینه",field:"costCenter",valueFormatter:a=>{var e;return(e=a.value)==null?void 0:e.name},rowGroup:!0,hide:!0},{headerName:"سمت شغلی",field:"jobPosition",valueFormatter:a=>{var e;return(e=a.value)==null?void 0:e.name},rowGroup:!0,hide:!0},{headerName:"کد پرسنلی",field:"personnelCode"},{headerName:"نام",field:"firstName"},{headerName:"نام خانوادگی",field:"lastName"},{headerName:"وضعیت",field:"active",cellRenderer:"Active",cellStyle:{display:"flex","align-items":"center"},filterParams:{valueFormatter:a=>a.value===1?"فعال":"غیرفعال"}}]),Z=y({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:a=>!(a.group&&a.field!=="jobPosition")});function M(){var a;return(a=V.value)==null?void 0:a.map(e=>{var o,t,d,C,B,I;return{id:e.id,personnelCode:Number.parseInt(e.personnel_code),firstName:e.first_name,lastName:e.last_name,active:e.active,workplace:(t=(o=e.profile)==null?void 0:o.workplace)==null?void 0:t.name,workArea:(C=(d=e.profile)==null?void 0:d.work_area)==null?void 0:C.name,costCenter:(B=e.profile)==null?void 0:B.cost_center,jobPosition:(I=e.profile)==null?void 0:I.job_position,approvalFlowAsRequester:e.approval_flows_as_requester}})}const ee=y({filter:"agGroupColumnFilter"});function j(a){let e;return v.value.forEachNode(o=>{var t,d,C;if(a.approver_user_id&&((t=o.data)==null?void 0:t.id)==a.approver_user_id||a.approver_position_id&&o.field==="jobPosition"&&((d=o.groupValue)==null?void 0:d.rayvarz_id)==a.approver_position_id&&((C=o.parent.groupValue)==null?void 0:C.rayvarz_id)==a.approver_center_id)return e=o,"break loop!"}),e}function D(){var a;n.value=v.value.getSelectedNodes();for(const e of n.value)v.value.setRowNodeExpanded(e,!0,!0);if(m.value==="view"){if(g.value=n.value,n.value.length!==1){c.value=[];return}if(n.value[0].field==="jobPosition"){const e=n.value[0].groupValue.rayvarz_id,o=n.value[0].parent.groupValue.rayvarz_id;c.value=b.value.filter(t=>t.requester_position_id===e&&t.requester_center_id===o).map(t=>j(t))}n.value[0].group||(c.value=n.value[0].data.approvalFlowAsRequester.map(e=>j(e)))}else if(m.value==="edit"){if(n.value.length!==0){const e=n.value[n.value.length-1];e.field==="jobPosition"&&e.allChildrenCount>1&&(r.hasError=!0,r.errorMessage="بیش از یک کاربر در سمت شغلی انتخاب شده وجود دارد. لطفاً کاربر مورد نظر خود را در این سمت انتخاب کنید.",e.setSelected(!1,!1)),((a=e.data)==null?void 0:a.active)===0&&(r.hasError=!0,r.errorMessage="کاربر غیرفعال را نمی‌توان به عنوان تأییدکننده انتخاب کرد.",e.setSelected(!1,!1))}c.value=n.value}}async function T(){var a;try{const{data:e,error:o}=await G($("/base/user/approval-flows-as-requester",{query:{requestTypeId:R.value[Array.isArray(u.value)?u.value[0]:u.value].id}}));if(o.value)throw o.value;V.value=e.value.data,(a=v.value)==null||a.setGridOption("rowData",M())}catch(e){console.error("Error fetching users:",e),r.hasError=!0,r.errorMessage=e.message||"خطا در دریافت کاربران"}}async function z(){try{const{data:a,error:e}=await G($("/base/approval-flow",{query:{"filter[request_type_id]":`\${${R.value[Array.isArray(u.value)?u.value[0]:u.value].id}}`}}));if(e.value)throw e.value;b.value=a.value.data}catch(a){console.error("Error fetching approval flows:",a),r.hasError=!0,r.errorMessage=a.message||"خطا در دریافت رده تأییدیه‌ها"}}async function ae(){try{const{data:a,error:e}=await G($("/base/request-type"));if(e.value)throw e.value;R.value=a.value.data}catch(a){console.error("Error fetching request types:",a),r.hasError=!0,r.errorMessage=a.message||"خطا در دریافت نوع درخواست‌ها"}}async function re(){const a=c.value.length===0;Array.isArray(u.value)||(u.value=[u.value]);const e=[];for(const o of u.value)for(const t of g.value)(a?[null]:c.value).forEach((d,C)=>{e.push({requester_user_id:t.group?null:t.data.id,requester_position_id:t.group?t.groupValue.rayvarz_id:null,requester_center_id:t.group?t.parent.groupValue.rayvarz_id:null,approver_user_id:a||d.group?null:d.data.id,approver_position_id:a?null:d.group?d.groupValue.rayvarz_id:null,approver_center_id:a?null:d.group?d.parent.groupValue.rayvarz_id:null,priority:C+1,request_type_id:R.value[o].id})});s.updateApprovalFlow=!0;try{await me("/base/approval-flow/update",{method:"POST",body:{approvalFlows:e},onResponseError({response:o}){r.hasError=!0,r.errorMessage=o._data.message||"خطا در بروزرسانی رده تأییدیه‌ها"}})}catch(o){console.error(o)}finally{T(),await z(),u.value=u.value[0],s.updateApprovalFlow=!1,m.value="view"}}async function te(){m.value==="view"&&(s.changeRequestType=!0,T(),await z(),D(),s.changeRequestType=!1)}function oe(a){c.value[a].setSelected(!1,!1),c.value.splice(a,1)}return[N,h]=H(()=>ae()),await N,h(),T(),[N,h]=H(()=>z()),await N,h(),ne(m,a=>{a==="view"?(v.value.deselectAll(),v.value.setNodesSelected({nodes:g.value.map(e=>v.value.getRowNode(e.id)),newValue:!0})):a==="edit"&&(v.value.deselectAll(),v.value.setNodesSelected({nodes:c.value.map(e=>v.value.getRowNode(e.id)),newValue:!0}))}),(a,e)=>{const o=de("AgGridVue");return p(),w(ye,{class:"app-layout"},{default:i(()=>[f(ge,{modelValue:l(r).hasError,"onUpdate:modelValue":e[0]||(e[0]=t=>l(r).hasError=t),timeout:2e3,location:"center",variant:"flat",color:"error"},{default:i(()=>[q(A(l(r).errorMessage),1)]),_:1},8,["modelValue"]),f(J,{class:"mb-3",color:l(m)==="edit"?"yellow-lighten-4":""},{default:i(()=>[f(K,{class:"pa-3"},{default:i(()=>[f(pe,{modelValue:l(u),"onUpdate:modelValue":[e[1]||(e[1]=t=>ce(u)?u.value=t:null),te],column:"",multiple:l(m)==="edit",mandatory:""},{default:i(()=>[(p(!0),F(x,null,P(l(R),(t,d)=>(p(),w(E,{key:t.id,variant:"outlined",filter:"",disabled:l(s).changeRequestType},{default:i(()=>[q(A(t.name)+" ",1),l(s).changeRequestType&&d===l(u)?(p(),w(ve,{key:0,class:"mr-2",size:20,width:2,indeterminate:""})):k("",!0)]),_:2},1032,["disabled"]))),128))]),_:1},8,["modelValue","multiple"])]),_:1})]),_:1},8,["color"]),W("div",null,[l(n).length>0||l(m)==="edit"?(p(),w(we,{key:0,requesters:l(g),"approval-flow":l(c),mode:l(m),loading:l(s).updateApprovalFlow,onEdit:e[2]||(e[2]=t=>m.value="edit"),onSave:re,onCancel:e[3]||(e[3]=t=>m.value="view"),onRemoveApprover:oe},null,8,["requesters","approval-flow","mode","loading"])):k("",!0)]),W("section",_e,[f(o,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":l(Y),"get-row-id":t=>String(t.data.id),"enable-rtl":"","row-numbers":"",pagination:"","group-display-type":"multipleColumns","auto-group-column-def":l(ee),"cell-selection":"","row-selection":l(Z),theme:l(Q),onGridReady:X,onSelectionChanged:D},null,8,["column-defs","get-row-id","auto-group-column-def","row-selection","theme"])])]),_:1})}}},ze=ue(he,[["__scopeId","data-v-64fa5f4b"]]);export{ze as default};
