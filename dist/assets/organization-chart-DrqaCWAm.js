import{b as te,d as oe,V as J}from"./VCard-DXyMAqZ9.js";import{f as y,o as d,e as i,b as w,v as N,c as F,F as x,i as P,a2 as S,x as A,m as k,a1 as le,am as G,M as ue,bL as U,r as g,a7 as L,c8 as O,w as se,a as ie,d as H,n as l,ch as ne,bq as de,ci as pe}from"./index-CTn1zpMl.js";import{V as K}from"./VCardText-Bf9VcR3P.js";import{u as ce,V as ve}from"./VLayout-DP4UPJQH.js";import{u as z}from"./useApi-DkrqySTn.js";import{c as $}from"./createUrl-Ci1yB_A5.js";import{$ as fe}from"./api-CIiSBdAt.js";import{V as me}from"./VSnackbar-BIzAdlyD.js";import"./createSimpleFunctional-BLD9Lq1U.js";import"./useLogout-cMquD6Tt.js";import"./VOverlay-D193HQRA.js";const ge={__name:"ApprovalFlow",props:{requesters:{required:!0},approvalFlow:{type:Array,required:!0},mode:{type:String,required:!0},loading:{type:Boolean,default:!0}},setup(_){const h=_;return(V,r)=>(d(),y(J,{class:"mb-3",color:_.mode==="edit"?"yellow-lighten-4":""},{default:i(()=>[w(te,{class:"text-wrap"},{default:i(()=>[r[3]||(r[3]=N(" رده تأییدیه‌های ",-1)),(d(!0),F(x,null,P(h.requesters,u=>(d(),y(S,{key:u.id,variant:"outlined",color:"info",class:"ml-3 mb-3"},{default:i(()=>{var q,b,m;return[N(A((q=u.data)==null?void 0:q.firstName)+" "+A((b=u.data)==null?void 0:b.lastName)+" "+A((m=u.groupValue)==null?void 0:m.name),1)]}),_:2},1024))),128))]),_:1}),w(K,{class:"d-flex align-center pa-5"},{default:i(()=>[(d(!0),F(x,null,P(h.approvalFlow,(u,q)=>(d(),F("div",{key:q},[w(S,{color:"primary"},{default:i(()=>{var b,m,c;return[N(A((b=u.data)==null?void 0:b.firstName)+" "+A((m=u.data)==null?void 0:m.lastName)+" "+A((c=u.groupValue)==null?void 0:c.name),1)]}),_:2},1024),q!==h.approvalFlow.length-1?(d(),y(S,{key:0,variant:"text",color:"primary"},{default:i(()=>[w(le,{icon:"tabler-chevron-left"})]),_:1})):k("",!0)]))),128))]),_:1}),w(oe,null,{default:i(()=>[_.mode==="edit"?(d(),y(G,{key:0,color:"success",loading:_.loading,onClick:r[0]||(r[0]=u=>V.$emit("save"))},{default:i(()=>[...r[4]||(r[4]=[N(" ذخیره ",-1)])]),_:1},8,["loading"])):k("",!0),_.mode==="edit"?(d(),y(G,{key:1,color:"error",disabled:_.loading,onClick:r[1]||(r[1]=u=>V.$emit("cancel"))},{default:i(()=>[...r[5]||(r[5]=[N(" بستن ",-1)])]),_:1},8,["disabled"])):k("",!0),_.mode==="view"?(d(),y(G,{key:2,color:"warning",onClick:r[2]||(r[2]=u=>V.$emit("edit"))},{default:i(()=>[...r[6]||(r[6]=[N(" ویرایش ",-1)])]),_:1})):k("",!0)]),_:1})]),_:1},8,["color"]))}},ye={style:{"block-size":"100%"}},we={__name:"organization-chart",async setup(_){let h,V;const r=U({hasError:!1,errorMessage:""}),u=U({updateApprovalFlow:!1,changeRequestType:!1}),q=g([]),b=g([]),m=g([]),c=g([]),v=g("view"),p=L(null),f=g([]),R=g([]),s=L(0),{theme:Q}=ce();function W(a){p.value=a.api,p.value.setGridOption("rowData",D())}const X=g([{headerName:"محل کار",field:"workplace",rowGroup:!0,hide:!0},{headerName:"منطقه کاری",field:"workArea",rowGroup:!0,hide:!0},{headerName:"مرکز هزینه",field:"costCenter",valueFormatter:a=>{var e;return(e=a.value)==null?void 0:e.name},rowGroup:!0,hide:!0},{headerName:"سمت شغلی",field:"jobPosition",valueFormatter:a=>{var e;return(e=a.value)==null?void 0:e.name},rowGroup:!0,hide:!0},{headerName:"کد پرسنلی",field:"personnelCode"},{headerName:"نام",field:"firstName"},{headerName:"نام خانوادگی",field:"lastName"},{headerName:"وضعیت",field:"active",cellRenderer:"Active",cellStyle:{display:"flex","align-items":"center"},filterParams:{valueFormatter:a=>a.value===1?"فعال":"غیرفعال"}}]),Y=g({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:a=>!(a.group&&a.field!=="jobPosition")});function D(){var a;return(a=q.value)==null?void 0:a.map(e=>{var t,o,n,C,M,I;return{id:e.id,personnelCode:Number.parseInt(e.personnel_code),firstName:e.first_name,lastName:e.last_name,active:e.active,workplace:(o=(t=e.profile)==null?void 0:t.workplace)==null?void 0:o.name,workArea:(C=(n=e.profile)==null?void 0:n.work_area)==null?void 0:C.name,costCenter:(M=e.profile)==null?void 0:M.cost_center,jobPosition:(I=e.profile)==null?void 0:I.job_position,approvalFlowAsRequester:e.approval_flows_as_requester}})}const Z=g({filter:"agGroupColumnFilter"});function j(a){let e;return p.value.forEachNode(t=>{var o,n,C;if(a.approver_user_id&&((o=t.data)==null?void 0:o.id)==a.approver_user_id||a.approver_position_id&&t.field==="jobPosition"&&((n=t.groupValue)==null?void 0:n.rayvarz_id)==a.approver_position_id&&((C=t.parent.groupValue)==null?void 0:C.rayvarz_id)==a.approver_center_id)return e=t,"break loop!"}),e}function B(){f.value=p.value.getSelectedNodes();for(const a of f.value)p.value.setRowNodeExpanded(a,!0,!0);if(v.value==="view"){if(m.value=f.value,f.value.length!==1){c.value=[];return}if(f.value[0].field==="jobPosition"){const a=f.value[0].groupValue.rayvarz_id,e=f.value[0].parent.groupValue.rayvarz_id;c.value=b.value.filter(t=>t.requester_position_id===a&&t.requester_center_id===e).map(t=>j(t))}f.value[0].group||(c.value=f.value[0].data.approvalFlowAsRequester.map(a=>j(a)))}else v.value==="edit"&&(c.value=f.value)}async function T(){var a;try{const{data:e,error:t}=await z($("/base/user/approval-flows-as-requester",{query:{requestTypeId:R.value[Array.isArray(s.value)?s.value[0]:s.value].id}}));if(t.value)throw t.value;q.value=e.value.data,(a=p.value)==null||a.setGridOption("rowData",D())}catch(e){console.error("Error fetching users:",e),r.hasError=!0,r.errorMessage=e.message||"خطا در دریافت کاربران"}}async function E(){try{const{data:a,error:e}=await z($("/base/approval-flow",{query:{"filter[request_type_id]":`\${${R.value[Array.isArray(s.value)?s.value[0]:s.value].id}}`}}));if(e.value)throw e.value;b.value=a.value.data}catch(a){console.error("Error fetching approval flows:",a),r.hasError=!0,r.errorMessage=a.message||"خطا در دریافت رده تأییدیه‌ها"}}async function ee(){try{const{data:a,error:e}=await z($("/base/request-type"));if(e.value)throw e.value;R.value=a.value.data}catch(a){console.error("Error fetching request types:",a),r.hasError=!0,r.errorMessage=a.message||"خطا در دریافت نوع درخواست‌ها"}}async function ae(){const a=c.value.length===0;Array.isArray(s.value)||(s.value=[s.value]);const e=[];for(const t of s.value)for(const o of m.value)(a?[null]:c.value).forEach((n,C)=>{e.push({requester_user_id:o.group?null:o.data.id,requester_position_id:o.group?o.groupValue.rayvarz_id:null,requester_center_id:o.group?o.parent.groupValue.rayvarz_id:null,approver_user_id:a||n.group?null:n.data.id,approver_position_id:a?null:n.group?n.groupValue.rayvarz_id:null,approver_center_id:a?null:n.group?n.parent.groupValue.rayvarz_id:null,priority:C+1,request_type_id:R.value[t].id})});u.updateApprovalFlow=!0;try{await fe("/base/approval-flow/update",{method:"POST",body:{approvalFlows:e},onResponseError({response:t}){r.hasError=!0,r.errorMessage=t._data.message||"خطا در بروزرسانی رده تأییدیه‌ها"}})}catch(t){console.error(t)}finally{T(),await E(),s.value=s.value[0],u.updateApprovalFlow=!1,v.value="view"}}async function re(){v.value==="view"&&(u.changeRequestType=!0,T(),await E(),B(),u.changeRequestType=!1)}return[h,V]=O(()=>ee()),await h,V(),T(),[h,V]=O(()=>E()),await h,V(),se(v,a=>{a==="view"?(p.value.deselectAll(),p.value.setNodesSelected({nodes:m.value.map(e=>p.value.getRowNode(e.id)),newValue:!0})):a==="edit"&&(p.value.deselectAll(),p.value.setNodesSelected({nodes:c.value.map(e=>p.value.getRowNode(e.id)),newValue:!0}))}),(a,e)=>{const t=ie("AgGridVue");return d(),y(ve,{class:"app-layout"},{default:i(()=>[w(me,{modelValue:l(r).hasError,"onUpdate:modelValue":e[0]||(e[0]=o=>l(r).hasError=o),timeout:2e3,location:"center",variant:"outlined",color:"error"},{default:i(()=>[N(A(l(r).errorMessage),1)]),_:1},8,["modelValue"]),w(J,{class:"mb-3",color:l(v)==="edit"?"yellow-lighten-4":""},{default:i(()=>[w(K,{class:"pa-3"},{default:i(()=>[w(ne,{modelValue:l(s),"onUpdate:modelValue":[e[1]||(e[1]=o=>de(s)?s.value=o:null),re],column:"",multiple:l(v)==="edit",mandatory:""},{default:i(()=>[(d(!0),F(x,null,P(l(R),(o,n)=>(d(),y(S,{key:o.id,variant:"outlined",filter:"",disabled:l(u).changeRequestType},{default:i(()=>[N(A(o.name)+" ",1),l(u).changeRequestType&&n===l(s)?(d(),y(pe,{key:0,class:"mr-2",size:20,width:2,indeterminate:""})):k("",!0)]),_:2},1032,["disabled"]))),128))]),_:1},8,["modelValue","multiple"])]),_:1})]),_:1},8,["color"]),H("div",null,[l(f).length>0||l(v)==="edit"?(d(),y(ge,{key:0,requesters:l(m),"approval-flow":l(c),mode:l(v),loading:l(u).updateApprovalFlow,onEdit:e[2]||(e[2]=o=>v.value="edit"),onSave:ae,onCancel:e[3]||(e[3]=o=>v.value="view")},null,8,["requesters","approval-flow","mode","loading"])):k("",!0)]),H("section",ye,[w(t,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":l(X),"get-row-id":o=>String(o.data.id),"enable-rtl":"","row-numbers":"",pagination:"","group-display-type":"multipleColumns","auto-group-column-def":l(Z),"cell-selection":"","row-selection":l(Y),theme:l(Q),onGridReady:W,onSelectionChanged:B},null,8,["column-defs","get-row-id","auto-group-column-def","row-selection","theme"])])]),_:1})}}},Se=ue(we,[["__scopeId","data-v-47903842"]]);export{Se as default};
