import{_ as A}from"./AreYouSureDialog-CwbwxbHJ.js";import{r as S}from"./validators-DkGyzL9w.js";import{U as q,r as f,a as U,f as D,o as v,e as n,b as r,d as Y,bx as I,aF as L,bq as E,n as o,am as M,v as R,M as z,bH as N,bJ as F,Y as G,m as j,x as H,bK as T}from"./index-ooPP5feG.js";import{_ as O}from"./DialogCloseBtn-aJc2tGC_.js";import{V as J}from"./VCard-Dj5J9-Kf.js";import{V as K}from"./VCardText-IE3xu6FL.js";import{V as X}from"./VForm-DQt9jIPT.js";import{V as Z,a as w}from"./VRow-DEdepqIw.js";import{V as Q}from"./VFileInput-T7RgAMUk.js";import{V as W}from"./VDialog-CLC_IlIU.js";import{u as ee}from"./useAGGridTheme-CX0Ff-w_.js";import{u as ae}from"./useApi-DGBJ2oD4.js";import{c as le}from"./createUrl-BBqkNlhK.js";import{$ as x}from"./api-DPKt4gjB.js";import{V as te}from"./VSnackbar-BmdJh8SS.js";import{V as oe}from"./VFab-C6TVCok5.js";import{V as re}from"./VLayout-V2nzgsV5.js";import"./helpers-4BKJjDfb.js";import"./createSimpleFunctional-CubpmDyw.js";/* empty css              */import"./VField-Bfg3KhAz.js";import"./VOverlay-1ZS_oVde.js";import"./VCounter-B4QNp_lS.js";import"./dialog-transition-C_o_ZCcG.js";import"./useLogout-DmDC2nSK.js";const se={__name:"PayrollBatchCreateDialog",props:{isDialogVisible:{type:Boolean,required:!0},loading:{type:Boolean,required:!0}},emits:["submit","update:isDialogVisible"],setup(c,{emit:l}){const s=c,u=l,h=q("constants"),p=f(null),b=f(),y=f(null),P=[d=>{const t=d.name.split(".").pop().toLowerCase();return t!=="xlsx"&&t!=="xls"?"لطفا یک فایل اکسل معتبر انتخاب کنید!":d.size>h.MAX_FILE_SIZE?"حجم فایل باید کمتر از 5 مگابایت باشد!":!0}],_=[()=>!!p.value||"لطفا دوره فیش را انتخاب کنید!"];function C(){var d;(d=b.value)==null||d.validate().then(({valid:t})=>{t&&u("submit",{payrollBatchDate:p.value,payrollBatchFile:y.value})})}function V(){u("update:isDialogVisible",!1)}function B(d){u("update:isDialogVisible",d)}return(d,t)=>{const e=O,a=U("PersianDatetimePicker");return v(),D(W,{width:d.$vuetify.display.smAndDown?"auto":900,"model-value":s.isDialogVisible,"onUpdate:modelValue":B},{default:n(()=>[r(e,{onClick:t[0]||(t[0]=i=>B(!1))}),r(J,null,{default:n(()=>[r(K,null,{default:n(()=>[t[6]||(t[6]=Y("h4",{class:"text-h5 text-center mb-2"}," افزودن فیش حقوقی جدید ",-1)),r(X,{ref_key:"refVForm",ref:b,class:"mt-6","validate-on":"submit lazy",onSubmit:I(C,["prevent"])},{default:n(()=>[r(Z,null,{default:n(()=>[r(w,{cols:"12",md:"6"},{default:n(()=>[r(L,{rules:_,disabled:c.loading},{default:n(()=>[r(a,{modelValue:o(p),"onUpdate:modelValue":t[1]||(t[1]=i=>E(p)?p.value=i:null),disabled:c.loading,type:"year-month",simple:"",label:"دوره فیش"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),r(w,{cols:"12",md:"6"},{default:n(()=>[r(Q,{modelValue:o(y),"onUpdate:modelValue":t[2]||(t[2]=i=>E(y)?y.value=i:null),disabled:c.loading,label:"فایل اکسل",accept:".xlsx, .xls",rules:["requiredValidator"in d?d.requiredValidator:o(S),...P]},null,8,["modelValue","disabled","rules"])]),_:1}),r(w,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:n(()=>[r(M,{type:"submit",disabled:c.loading,loading:c.loading,onClick:t[3]||(t[3]=i=>{var m;return(m=o(b))==null?void 0:m.validate()})},{default:n(()=>[...t[4]||(t[4]=[R(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),r(M,{color:"secondary",variant:"tonal",onClick:V},{default:n(()=>[...t[5]||(t[5]=[R(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},ie={style:{"block-size":"100%"}},ne={__name:"payroll-batches-management",setup(c){const l=N({hasError:!1,errorMessage:"",isPayrollBatchDeleteDialogVisible:!1,isPayrollBatchCreateDialogVisible:!1}),s=N({createPayrollBatch:!1,fetchPayrollBatches:!1,deletePayrollBatches:!1,fetchReports:!1}),u=f([]),h=f([]),p=f(null),{theme:b}=ee();function y(e){p.value=e.api}const P=f([{headerName:"ماه",field:"monthName"},{headerName:"سال",field:"year"},{headerName:"بارگذاری توسط",field:"uploadedBy"},{headerName:"تاریخ بارگذاری",field:"createdAt",valueFormatter:e=>F(e.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"نام فایل بارگذاری شده",field:"fileName"},{headerName:"عملیات",field:"actions",cellRendererSelector:e=>({component:"Actions",params:{onDeleteClick:a=>{h.value=[a],l.isPayrollBatchDeleteDialogVisible=!0}}})}]),_=G(()=>{var e;return(e=u.value)==null?void 0:e.map(a=>({id:a.id,month:a.month,monthName:a.month_name,year:a.year,uploadedBy:`${a.uploaded_by.first_name} ${a.uploaded_by.last_name}`,createdAt:F(a.created_at).format("jYYYY-jMM-jDD HH:mm:ss"),fileName:a.filename,actions:{deletable:!0}}))});function C(e){return[{icon:'<i class="tabler tabler-file-analytics" style="font-size: 18px;"></i>',name:"گزارشات",action:()=>{t(e.node.data.month,e.node.data.year)}},"separator",...e.defaultItems]}async function V(){s.fetchPayrollBatches=!0;try{const{data:e,error:a}=await ae(le("/payroll/payroll-batch",{query:{"fields[uploaded_bies]":"id,first_name,last_name",include:"uploadedBy"}}));if(s.fetchPayrollBatches=!1,a.value)throw a.value;u.value=e.value.data}catch(e){console.error("Error fetching payrollBatches:",e),l.hasError=!0,l.errorMessage=e.message||"خطا در دریافت فیش‌های حقوقی"}}V();async function B(e){const a=new FormData;a.append("month",Number(e.payrollBatchDate.split("/")[1])),a.append("year",Number(e.payrollBatchDate.split("/")[0])),a.append("file",e.payrollBatchFile),s.createPayrollBatch=!0;try{await x("/payroll/payroll-batch/create",{method:"POST",body:a,onResponseError({response:i}){l.hasError=!0,l.errorMessage=i._data.message||"خطا در ایجاد فیش حقوقی"}}),l.isPayrollBatchCreateDialogVisible=!1}catch(i){console.error(i)}finally{s.createPayrollBatch=!1,V()}}async function d(){s.deletePayrollBatches=!0;try{await x("/payroll/payroll-batch",{method:"DELETE",body:{ids:[h.value[0].data.id]},onResponseError({response:e}){s.deletePayrollBatches=!1,l.hasError=!0,l.errorMessage=e._data.message||"خطا در حذف فیش حقوقی"}}),s.deletePayrollBatches=!1,l.isPayrollBatchDeleteDialogVisible=!1,u.value=u.value.filter(e=>e.id!==h.value[0].data.id)}catch(e){console.error(e)}}async function t(e,a){s.fetchReports=!0;try{const i=await x("/payroll/payroll-slip/reports",{method:"GET",query:{month:e,year:a},responseType:"blob",onResponseError({response:$}){s.fetchReports=!1,l.hasError=!0,l.errorMessage=$._data.message||"خطا در دریافت گزارش فیش حقوقی"}}),m=new Blob([i],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),k=window.URL.createObjectURL(m),g=document.createElement("a");g.href=k,g.download=`فیش حقوقی مشاهده نشده ماه ${e} سال ${a}.xlsx`,document.body.appendChild(g),g.click(),window.URL.revokeObjectURL(k),document.body.removeChild(g),s.fetchReports=!1}catch(i){console.error(i)}}return(e,a)=>{const i=U("AgGridVue");return v(),D(re,{class:"app-layout"},{default:n(()=>[r(te,{modelValue:o(l).hasError,"onUpdate:modelValue":a[0]||(a[0]=m=>o(l).hasError=m),timeout:2e3,location:"center",variant:"flat",color:"error"},{default:n(()=>[R(H(o(l).errorMessage),1)]),_:1},8,["modelValue"]),Y("section",ie,[r(i,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":o(P),"row-data":o(_),loading:o(s).fetchPayrollBatches,"enable-rtl":"","row-numbers":"",pagination:"",theme:o(b),"get-context-menu-items":C,onGridReady:y},null,8,["column-defs","row-data","loading","theme"])]),o(l).isPayrollBatchCreateDialogVisible?(v(),D(se,{key:0,"is-dialog-visible":o(l).isPayrollBatchCreateDialogVisible,"onUpdate:isDialogVisible":a[1]||(a[1]=m=>o(l).isPayrollBatchCreateDialogVisible=m),loading:o(s).createPayrollBatch,onSubmit:B},null,8,["is-dialog-visible","loading"])):j("",!0),o(l).isPayrollBatchDeleteDialogVisible?(v(),D(A,{key:1,"is-dialog-visible":o(l).isPayrollBatchDeleteDialogVisible,"onUpdate:isDialogVisible":a[2]||(a[2]=m=>o(l).isPayrollBatchDeleteDialogVisible=m),title:"آیا از حذف این فیش اطمینان دارید؟",loading:o(s).deletePayrollBatches,onConfirm:d},null,8,["is-dialog-visible","loading"])):j("",!0),r(T,null,{default:n(()=>[r(oe,{app:"",icon:"tabler-plus",size:"x-large",onClick:a[3]||(a[3]=m=>o(l).isPayrollBatchCreateDialogVisible=!0)})]),_:1})]),_:1})}}},je=z(ne,[["__scopeId","data-v-e49dde93"]]);export{je as default};
