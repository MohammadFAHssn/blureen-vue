import{_ as ie}from"./AreYouSureDialog-DFe4X3ft.js";import{_ as L}from"./DialogCloseBtn-CVlGvi40.js";import{r as k,f as E,o as v,e as l,b as e,m as A,v as y,d as C,bO as le,c as F,x as H,bx as K,bq as I,n as s,am as U,a as Q,aF as z,bK as S,w as se,bN as oe,F as re,i as ne,M as de,bP as T,Y as ue,bQ as fe}from"./index-BkbZDJsl.js";import{V as O,b as J,c as me}from"./VCard-C25xtgcG.js";import{V as _}from"./VCardText-C_kcHw9D.js";import{V as W}from"./VForm-D6xoxhGu.js";import{V as G,a as M}from"./VRow-pGFvvUuj.js";import{V as ce}from"./VFileInput-DV8JAefA.js";import{V as q}from"./VDialog-CSbebj_D.js";import{r as X}from"./validators-DkGyzL9w.js";import{V as Z}from"./VTextField-aGE2rDdt.js";import{$}from"./api-8hJccXN2.js";import{V as ge}from"./VTable-c-NZqzfM.js";import{u as he}from"./useAGGridTheme-BNC_v80N.js";import{V as be}from"./VSnackbar-DqziNmke.js";import{V as pe}from"./VFab-DWefMVk6.js";import{V as Ve}from"./VLayout-D0dtloUf.js";import"./createSimpleFunctional-V_pJsafn.js";/* empty css              */import"./VField-D71m8S2j.js";import"./VOverlay-B-Ee9g9p.js";import"./VCounter-CmsgilPQ.js";import"./dialog-transition-j7pwnRAQ.js";import"./helpers-4BKJjDfb.js";import"./useLogout-DF8hDxpD.js";const Ce={class:"text-caption d-flex justify-space-between"},De={key:0},ve={__name:"HealthCertificateAddImageDialog",props:{loading:Boolean,isDialogVisible:Boolean,progress:{type:Number,default:0},total:{type:Number,default:0},done:{type:Number,default:0},failed:{type:Number,default:0}},emits:["submit","update:isDialogVisible"],setup(n,{emit:t}){const d=n,b=t,V=k(),u=k([]),p=[r=>{if(!r.length)return"حداقل یک تصویر انتخاب کنید!";if(r.length>3e3)return"حداکثر می‌توانید 3000 تصویر انتخاب کنید!";for(const a of r){const g=a.name.split(".").pop().toLowerCase();if(!["jpg","jpeg","png"].includes(g))return"فقط فایل‌های تصویری (jpg, jpeg, png) مجاز هستند!";if(a.size>2*1024*1024)return`حجم هر تصویر باید کمتر از ${2*1024*1024/1024/1024} مگابایت باشد!`}return!0}];function N(){var r;(r=V.value)==null||r.validate().then(({valid:a})=>{a&&b("submit",{healthCertificateImages:u.value})})}function D(){b("update:isDialogVisible",!1)}function f(r){b("update:isDialogVisible",r)}return(r,a)=>{const g=L;return v(),E(q,{width:r.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":f},{default:l(()=>[e(g,{onClick:a[0]||(a[0]=w=>f(!1))}),e(O,null,{default:l(()=>[e(J,{class:"text-h6"},{default:l(()=>[...a[2]||(a[2]=[y(" افزودن عکس ",-1)])]),_:1}),n.loading?(v(),E(_,{key:0,class:"pt-0"},{default:l(()=>[e(le,{"model-value":n.progress,height:"10",color:"primary",rounded:"",striped:"",class:"mb-2"},null,8,["model-value"]),C("div",Ce,[a[3]||(a[3]=C("span",null,"در حال آپلود...",-1)),C("span",null,[y(H(n.done)+" / "+H(n.total)+" ",1),n.failed?(v(),F("span",De," | ناموفق: "+H(n.failed),1)):A("",!0),y(" | "+H(Math.round(n.progress))+"% ",1)])])]),_:1})):A("",!0),e(_,null,{default:l(()=>[e(W,{ref_key:"refVForm",ref:V,class:"mt-2","validate-on":"submit lazy",onSubmit:K(N,["prevent"])},{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",md:"12"},{default:l(()=>[e(ce,{modelValue:s(u),"onUpdate:modelValue":a[1]||(a[1]=w=>I(u)?u.value=w:null),multiple:"",chips:"","show-size":"",disabled:n.loading,label:"تصاویر (حداکثر 3000 فایل)",accept:"image/*",rules:p},null,8,["modelValue","disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e(U,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...a[4]||(a[4]=[y(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e(U,{color:"secondary",variant:"tonal",disabled:n.loading,onClick:D},{default:l(()=>[...a[5]||(a[5]=[y(" انصراف ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},ye={__name:"HealthCertificateCreateDialog",props:{isDialogVisible:{type:Boolean,required:!0},loading:{type:Boolean,required:!0}},emits:["submit","update:isDialogVisible"],setup(n,{emit:t}){const d=n,b=t,V=k(),u=k(null),p=k([]),N=[()=>!!u.value||"لطفا دوره را انتخاب کنید!"];function D(){var a;(a=V.value)==null||a.validate().then(({valid:g})=>{g&&b("submit",{healthCertificateDate:u.value,healthCertificateName:p.value})})}function f(){b("update:isDialogVisible",!1)}function r(a){b("update:isDialogVisible",a)}return(a,g)=>{const w=L,m=Q("PersianDatetimePicker");return v(),E(q,{width:a.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":r},{default:l(()=>[e(w,{onClick:g[0]||(g[0]=Y=>r(!1))}),e(O,null,{default:l(()=>[e(_,null,{default:l(()=>[g[5]||(g[5]=C("h4",{class:"text-h5 text-center mb-2"}," ایجاد گروه شناسنامه جدید ",-1)),e(W,{ref_key:"refVForm",ref:V,class:"mt-6","validate-on":"submit lazy",onSubmit:K(D,["prevent"])},{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{disabled:n.loading},{default:l(()=>[e(s(Z),{modelValue:s(p),"onUpdate:modelValue":g[1]||(g[1]=Y=>I(p)?p.value=Y:null),rules:["requiredValidator"in a?a.requiredValidator:s(X)],disabled:n.loading,simple:"",label:"نام"},null,8,["modelValue","rules","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{rules:N,disabled:n.loading},{default:l(()=>[e(m,{modelValue:s(u),"onUpdate:modelValue":g[2]||(g[2]=Y=>I(u)?u.value=Y:null),disabled:n.loading,type:"year-month",simple:"",label:"دوره شناسنامه"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e(U,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...g[3]||(g[3]=[y(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e(U,{color:"secondary",variant:"tonal",onClick:f},{default:l(()=>[...g[4]||(g[4]=[y(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},He={key:0,class:"d-flex justify-center align-center h-100"},ke={key:1},we={key:2,class:"text-center text-medium-emphasis mt-3"},je={__name:"HealthCertificateDetailsDialog",props:{file:Object,loading:Boolean,isDialogVisible:Boolean},emits:["update:isDialogVisible"],setup(n,{emit:t}){const d=n,b=t,V=S({fetchingHealthCertificateUsers:!1}),u=k([]),p=S({hasError:!1,message:""});async function N(D){if(D){V.fetchingHealthCertificateUsers=!0;try{const f=await $(`/hse/health-certificate/file/${D}`,{method:"GET"});u.value=(f==null?void 0:f.data)??[],p.hasError=!1,p.message=""}catch(f){console.error("fetchHealthCertificateUsers error:",f),p.hasError=!0,p.message=(f==null?void 0:f.message)??"خطا در دریافت کاربران",u.value=[]}finally{V.fetchingHealthCertificateUsers=!1}}}return se(()=>{var D;return(D=d.file)==null?void 0:D.id},D=>{D?N(D):u.value=[]},{immediate:!0}),(D,f)=>(v(),E(q,{width:D.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":f[1]||(f[1]=r=>b("update:isDialogVisible",r))},{default:l(()=>[e(O,null,{default:l(()=>[e(J,{class:"text-h6 text-center"},{default:l(()=>[y(" کاربران دوره شناسنامه: "+H(d.file.name),1)]),_:1}),e(_,{class:"scrollable-content"},{default:l(()=>[s(V).fetchingHealthCertificateUsers?(v(),F("div",He,[e(oe,{indeterminate:"",color:"primary",size:"64"})])):s(u)?(v(),F("div",ke,[e(ge,{"fixed-header":"",height:400,density:"comfortable"},{default:l(()=>[f[2]||(f[2]=C("thead",null,[C("tr",null,[C("th",null,"ردیف"),C("th",null,"نام"),C("th",null,"کد پرسنلی"),C("th",null,"شناسنامه")])],-1)),C("tbody",null,[(v(!0),F(re,null,ne(s(u),(r,a)=>(v(),F("tr",{key:r.id},[C("td",null,H(a+1),1),C("td",null,H(r.first_name)+" "+H(r.last_name),1),C("td",null,H(r.personnel_code),1),C("td",null,H(r.health_certificate.some(g=>{var w;return g.health_certificate_id===((w=d.file)==null?void 0:w.id)})?"آپلود شده":"ندارد"),1)]))),128))])]),_:1})])):(v(),F("div",we," هیچ کاربری یافت نشد. "))]),_:1}),e(me,{class:"justify-end"},{default:l(()=>[e(U,{color:"primary",text:"",onClick:f[0]||(f[0]=r=>b("update:isDialogVisible",!1))},{default:l(()=>[...f[3]||(f[3]=[y(" بستن ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["width","model-value"]))}},Ee={__name:"HealthCertificateEditDialog",props:{file:Object,loading:Boolean,isDialogVisible:Boolean},emits:["submit","update:isDialogVisible"],setup(n,{emit:t}){const d=n,b=t,V=k(),u=k(null),p=k(d.file.name);function N(){var r;(r=V.value)==null||r.validate().then(({valid:a})=>{a&&b("submit",{healthCertificateDate:u.value,healthCertificateName:p.value})})}function D(){b("update:isDialogVisible",!1)}function f(r){b("update:isDialogVisible",r)}return(r,a)=>{const g=L,w=Q("PersianDatetimePicker");return v(),E(q,{width:r.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":f},{default:l(()=>[e(g,{onClick:a[0]||(a[0]=m=>f(!1))}),e(O,null,{default:l(()=>[e(J,{class:"text-h6"},{default:l(()=>[y(" ویرایش شناسنامه: "+H(d.file.name),1)]),_:1}),e(_,null,{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",sm:"6"},{default:l(()=>[C("p",null,[a[3]||(a[3]=C("strong",null,"ماه:",-1)),y(" "+H(d.file.month),1)])]),_:1}),e(M,{cols:"12",sm:"6"},{default:l(()=>[C("p",null,[a[4]||(a[4]=C("strong",null,"سال:",-1)),y(" "+H(d.file.year),1)])]),_:1})]),_:1}),e(W,{ref_key:"refVForm",ref:V,class:"mt-6","validate-on":"submit lazy",onSubmit:K(N,["prevent"])},{default:l(()=>[e(G,null,{default:l(()=>[e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{disabled:n.loading},{default:l(()=>[e(Z,{modelValue:s(p),"onUpdate:modelValue":a[1]||(a[1]=m=>I(p)?p.value=m:null),rules:["requiredValidator"in r?r.requiredValidator:s(X)],disabled:n.loading,simple:"",label:"نام"},null,8,["modelValue","rules","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",md:"6"},{default:l(()=>[e(z,{disabled:n.loading},{default:l(()=>[e(w,{modelValue:s(u),"onUpdate:modelValue":a[2]||(a[2]=m=>I(u)?u.value=m:null),disabled:n.loading,type:"year-month",simple:"",label:"دوره شناسنامه"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e(U,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...a[5]||(a[5]=[y(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e(U,{color:"secondary",variant:"tonal",onClick:D},{default:l(()=>[...a[6]||(a[6]=[y(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},Me={style:{"block-size":"100%"}},Ne={__name:"health-certificate-management",setup(n){const t=S({hasError:!1,errorMessage:"",isHealthCertificateCreateDialogVisible:!1,isHealthCertificateEditDialogVisible:!1,isHealthCertificateAddImageDialogVisible:!1,isHealthCertificateDeleteDialogVisible:!1,isHealthCertificateDetailsDialogVisible:!1}),d=S({createHealthCertificate:!1,editHealthCertificate:!1,addImageHealthCertificate:!1,fetchingHealthCertificates:!1,deleteHealthCertificate:!1,detailsHealthCertificate:!1}),b=k([]),V=k(null),u=k([]),p=k(null),{theme:N}=he();function D(c){p.value=c.api,p.value.setGridOption("loading",!0)}const f=k([{headerName:"نام",field:"name"},{headerName:"ماه",field:"month"},{headerName:"سال",field:"year"},{headerName:"بارگذاری توسط",field:"uploadedBy"},{headerName:"آخرین ویرایش توسط",field:"editedBy"},{headerName:"تاریخ بارگذاری",field:"createdAt",valueFormatter:c=>T(c.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"تاریخ آخرین ویرایش",field:"updatedAt",valueFormatter:c=>T(c.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"عملیات",field:"actions",cellRendererSelector:c=>({component:"Actions",params:{onDeleteClick:i=>{u.value=[i],t.isHealthCertificateDeleteDialogVisible=!0},onDetailsClick:i=>{u.value=[i],V.value=b.value.find(h=>h.id===i.data.id),t.isHealthCertificateDetailsDialogVisible=!0},onAddImageClick:i=>{u.value=[i],V.value=b.value.find(h=>h.id===i.data.id),t.isHealthCertificateAddImageDialogVisible=!0}}})}]),r=ue(()=>{var c;return(c=b.value)==null?void 0:c.map(i=>{var h,o;return{id:i.id,name:i.name,month:i.month,year:i.year,uploadedBy:((h=i.uploadedBy)==null?void 0:h.fullName)||"--",editedBy:((o=i.editedBy)==null?void 0:o.fullName)||"--",createdAt:T(i.createdAt).format("jYYYY-jMM-jDD HH:mm:ss"),updatedAt:T(i.updatedAt).format("jYYYY-jMM-jDD HH:mm:ss"),actions:{deletable:!0,detailsable:!0,addImage:!0}}})});async function a(){var c,i,h;d.fetchingHealthCertificates=!0,(c=p.value)==null||c.setGridOption("loading",!0);try{const o=await $("/hse/health-certificate/file/",{method:"GET"});b.value=((i=o==null?void 0:o.data)==null?void 0:i.healthCertificates)||[]}catch(o){console.error("Error fetching healthCertificates:",o),t.hasError=!0,t.errorMessage=o.message||"خطا در دریافت دوره‌های شناسنامه‌ها"}finally{d.fetchingHealthCertificates=!1,(h=p.value)==null||h.setGridOption("loading",!1)}}a();async function g(c){const i=new FormData;i.append("month",Number(c.healthCertificateDate.split("/")[1])),i.append("year",Number(c.healthCertificateDate.split("/")[0])),i.append("file_name",c.healthCertificateName),d.createHealthCertificate=!0;try{await $("/hse/health-certificate/file/",{method:"POST",body:i,onResponseError({response:h}){var o,x;if(t.hasError=!0,(o=h._data)!=null&&o.errors){const j=Object.values(h._data.errors).flat().join(" | ");t.errorMessage=j}else t.errorMessage=((x=h._data)==null?void 0:x.message)||"خطا در ایجاد"}}),t.isHealthCertificateCreateDialogVisible=!1}catch(h){console.error(h)}finally{d.createHealthCertificate=!1,a()}}async function w(c){const i=V.value.id,h=new FormData;c.healthCertificateDate&&(h.append("month",Number(c.healthCertificateDate.split("/")[1])),h.append("year",Number(c.healthCertificateDate.split("/")[0]))),h.append("file_name",c.healthCertificateName),d.editHealthCertificate=!0;try{await $(`/hse/health-certificate/file/${i}`,{method:"POST",body:h,onResponseError({response:o}){var x,j;if(t.hasError=!0,(x=o._data)!=null&&x.errors){const B=Object.values(o._data.errors).flat().join(" | ");t.errorMessage=B}else t.errorMessage=((j=o._data)==null?void 0:j.message)||"خطا در ویرایش"}}),t.isHealthCertificateEditDialogVisible=!1}catch(o){console.error(o)}finally{d.editHealthCertificate=!1,a()}}const m=S({active:!1,total:0,done:0,failed:0,percent:0});function Y(){m.active=!1,m.total=0,m.done=0,m.failed=0,m.percent=0}async function ee(c){const i=V.value.id,h=V.value.year,o=c.healthCertificateImages||[],x=19;if(o.length){Y(),m.active=!0,m.total=o.length,d.addImageHealthCertificate=!0,t.hasError=!1,t.errorMessage="";try{for(let j=0;j<o.length;j+=x){const B=o.slice(j,j+x),P=new FormData;B.forEach(R=>P.append("images[]",R,R.name)),P.append("id",String(i)),P.append("year",String(h));try{await $("/hse/health-certificate/file/image",{method:"POST",body:P}),m.done+=B.length}catch(R){console.error("batch upload failed:",R),m.failed+=B.length,t.hasError=!0,t.errorMessage="برخی از فایل‌ها بارگذاری نشدند."}const ae=m.done+m.failed;m.percent=m.total?ae/m.total*100:0}t.isHealthCertificateAddImageDialogVisible=!1}catch(j){console.error(j),t.hasError=!0,t.errorMessage="خطای غیرمنتظره در آپلود"}finally{d.addImageHealthCertificate=!1,m.active=!1,a()}}}async function te(){const c=u.value[0].data.id;d.deleteHealthCertificate=!0;try{await $(`/hse/health-certificate/file/${c}`,{method:"DELETE",onResponseError({response:i}){d.deleteHealthCertificate=!1,t.hasError=!0,t.errorMessage=i._data.message||"خطا در حذف"}}),d.deleteHealthCertificate=!1,t.isHealthCertificateDeleteDialogVisible=!1,b.value=b.value.filter(i=>i.id!==u.value[0].data.id)}catch(i){console.error(i)}}return(c,i)=>{const h=Q("AgGridVue");return v(),E(Ve,{class:"app-layout"},{default:l(()=>[e(be,{modelValue:s(t).hasError,"onUpdate:modelValue":i[0]||(i[0]=o=>s(t).hasError=o),timeout:2e3,location:"center",variant:"flat",color:"error"},{default:l(()=>[y(H(s(t).errorMessage),1)]),_:1},8,["modelValue"]),C("section",Me,[e(h,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":s(f),"row-data":s(r),"enable-rtl":"","row-numbers":"",pagination:"",theme:s(N),onGridReady:D},null,8,["column-defs","row-data","theme"])]),s(t).isHealthCertificateCreateDialogVisible?(v(),E(ye,{key:0,"is-dialog-visible":s(t).isHealthCertificateCreateDialogVisible,"onUpdate:isDialogVisible":i[1]||(i[1]=o=>s(t).isHealthCertificateCreateDialogVisible=o),loading:s(d).createHealthCertificate,onSubmit:g},null,8,["is-dialog-visible","loading"])):A("",!0),s(t).isHealthCertificateEditDialogVisible?(v(),E(Ee,{key:1,"is-dialog-visible":s(t).isHealthCertificateEditDialogVisible,"onUpdate:isDialogVisible":i[2]||(i[2]=o=>s(t).isHealthCertificateEditDialogVisible=o),loading:s(d).editHealthCertificate,file:s(V),onSubmit:w},null,8,["is-dialog-visible","loading","file"])):A("",!0),s(t).isHealthCertificateAddImageDialogVisible?(v(),E(ve,{key:2,"is-dialog-visible":s(t).isHealthCertificateAddImageDialogVisible,"onUpdate:isDialogVisible":i[3]||(i[3]=o=>s(t).isHealthCertificateAddImageDialogVisible=o),loading:s(d).addImageHealthCertificate||s(m).active,progress:s(m).percent,total:s(m).total,done:s(m).done,failed:s(m).failed,onSubmit:ee},null,8,["is-dialog-visible","loading","progress","total","done","failed"])):A("",!0),s(t).isHealthCertificateDetailsDialogVisible?(v(),E(je,{key:3,"is-dialog-visible":s(t).isHealthCertificateDetailsDialogVisible,"onUpdate:isDialogVisible":i[4]||(i[4]=o=>s(t).isHealthCertificateDetailsDialogVisible=o),loading:s(d).detailsHealthCertificate,file:s(V)},null,8,["is-dialog-visible","loading","file"])):A("",!0),s(t).isHealthCertificateDeleteDialogVisible?(v(),E(ie,{key:4,"is-dialog-visible":s(t).isHealthCertificateDeleteDialogVisible,"onUpdate:isDialogVisible":i[5]||(i[5]=o=>s(t).isHealthCertificateDeleteDialogVisible=o),title:"آیا از حذف این شناسنامه اطمینان دارید؟",loading:s(d).deleteHealthCertificate,onConfirm:te},null,8,["is-dialog-visible","loading"])):A("",!0),e(fe,null,{default:l(()=>[e(pe,{app:"",icon:"tabler-plus",size:"x-large",onClick:i[6]||(i[6]=o=>s(t).isHealthCertificateCreateDialogVisible=!0)})]),_:1})]),_:1})}}},tt=de(Ne,[["__scopeId","data-v-1e385b2f"]]);export{tt as default};
