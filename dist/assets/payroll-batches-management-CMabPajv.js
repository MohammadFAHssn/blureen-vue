import{_ as A}from"./AreYouSureDialog-BaBmVS21.js";import{r as S}from"./validators-BQd4MaJQ.js";import{r as f,a as $,f as V,o as B,e as i,b as r,d as j,bC as L,aH as I,bv as M,n as o,am as E,v as R,M as q,bJ as N,bK as F,Y as z,m as Y,x as G,bL as H}from"./index-BjDbercT.js";import{_ as T}from"./DialogCloseBtn-BX6Q5C0A.js";import{M as O}from"./constants-CqCubtRl.js";import{V as J}from"./VCard-DLNXAE8v.js";import{V as K}from"./VCardText-DJrV3pWu.js";import{V as X}from"./VForm-myuYE_Xh.js";import{V as Z}from"./VRow-LLRdI7I1.js";import{V as w}from"./VCol-qg2p72EP.js";import{V as Q}from"./VFileInput-3nJ1Z0BZ.js";import{V as W}from"./VDialog-TeVeCvfX.js";import{u as ee}from"./useAGGridTheme-xF0dHTm9.js";import{u as ae}from"./useApi-DXH5Gn3K.js";import{c as le}from"./createUrl-z7xFz3yT.js";import{$ as x}from"./api-DjFw6eZH.js";import{V as te}from"./VSnackbar-CHSK6Bj4.js";import{V as oe}from"./VFab-Cl93BQx4.js";import{V as re}from"./VLayout-vZ5Wssn-.js";import"./helpers-CcX6MmOA.js";import"./createSimpleFunctional-BP7hpzsR.js";/* empty css              */import"./VField-Bu2nJgTa.js";import"./VOverlay-BlrRlgQ7.js";import"./VCounter-fhqYYHf9.js";import"./dialog-transition-BfqVmbQh.js";import"./useLogout-kPLI9xuP.js";import"./index-CvOPxmL5.js";const se={__name:"PayrollBatchCreateDialog",props:{isDialogVisible:{type:Boolean,required:!0},loading:{type:Boolean,required:!0}},emits:["submit","update:isDialogVisible"],setup(p,{emit:l}){const s=p,u=l,m=f(null),h=f(),y=f(null),D=[n=>{const t=n.name.split(".").pop().toLowerCase();return t!=="xlsx"&&t!=="xls"?"لطفا یک فایل اکسل معتبر انتخاب کنید!":n.size>O?"حجم فایل باید کمتر از 5 مگابایت باشد!":!0}],v=[()=>!!m.value||"لطفا دوره فیش را انتخاب کنید!"];function P(){var n;(n=h.value)==null||n.validate().then(({valid:t})=>{t&&u("submit",{payrollBatchDate:m.value,payrollBatchFile:y.value})})}function C(){u("update:isDialogVisible",!1)}function b(n){u("update:isDialogVisible",n)}return(n,t)=>{const _=T,a=$("PersianDatetimePicker");return B(),V(W,{width:n.$vuetify.display.smAndDown?"auto":900,"model-value":s.isDialogVisible,"onUpdate:modelValue":b},{default:i(()=>[r(_,{onClick:t[0]||(t[0]=e=>b(!1))}),r(J,null,{default:i(()=>[r(K,null,{default:i(()=>[t[6]||(t[6]=j("h4",{class:"text-h5 text-center mb-2"}," افزودن فیش حقوقی جدید ",-1)),r(X,{ref_key:"refVForm",ref:h,class:"mt-6","validate-on":"submit lazy",onSubmit:L(P,["prevent"])},{default:i(()=>[r(Z,null,{default:i(()=>[r(w,{cols:"12",md:"6"},{default:i(()=>[r(I,{rules:v,disabled:p.loading},{default:i(()=>[r(a,{modelValue:o(m),"onUpdate:modelValue":t[1]||(t[1]=e=>M(m)?m.value=e:null),disabled:p.loading,type:"year-month",simple:"",label:"دوره فیش"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),r(w,{cols:"12",md:"6"},{default:i(()=>[r(Q,{modelValue:o(y),"onUpdate:modelValue":t[2]||(t[2]=e=>M(y)?y.value=e:null),disabled:p.loading,label:"فایل اکسل",accept:".xlsx, .xls",rules:["requiredValidator"in n?n.requiredValidator:o(S),...D]},null,8,["modelValue","disabled","rules"])]),_:1}),r(w,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:i(()=>[r(E,{type:"submit",disabled:p.loading,loading:p.loading,onClick:t[3]||(t[3]=e=>{var d;return(d=o(h))==null?void 0:d.validate()})},{default:i(()=>[...t[4]||(t[4]=[R(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),r(E,{color:"secondary",variant:"tonal",onClick:C},{default:i(()=>[...t[5]||(t[5]=[R(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},ie={style:{"block-size":"100%"}},ne={__name:"payroll-batches-management",setup(p){const l=N({hasError:!1,errorMessage:"",isPayrollBatchDeleteDialogVisible:!1,isPayrollBatchCreateDialogVisible:!1}),s=N({createPayrollBatch:!1,fetchPayrollBatches:!1,deletePayrollBatches:!1,fetchReports:!1}),u=f([]),m=f([]),h=f(null),{theme:y}=ee();function D(a){h.value=a.api}const v=f([{headerName:"ماه",field:"monthName"},{headerName:"سال",field:"year"},{headerName:"بارگذاری توسط",field:"uploadedBy"},{headerName:"تاریخ بارگذاری",field:"createdAt",valueFormatter:a=>F(a.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"نام فایل بارگذاری شده",field:"fileName"},{headerName:"عملیات",field:"actions",cellRendererSelector:a=>({component:"Actions",params:{onDeleteClick:e=>{m.value=[e],l.isPayrollBatchDeleteDialogVisible=!0}}})}]),P=z(()=>{var a;return(a=u.value)==null?void 0:a.map(e=>({id:e.id,month:e.month,monthName:e.month_name,year:e.year,uploadedBy:`${e.uploaded_by.first_name} ${e.uploaded_by.last_name}`,createdAt:F(e.created_at).format("jYYYY-jMM-jDD HH:mm:ss"),fileName:e.filename,actions:{deletable:!0}}))});function C(a){return[{icon:'<i class="tabler tabler-file-analytics" style="font-size: 18px;"></i>',name:"گزارشات",action:()=>{_(a.node.data.month,a.node.data.year)}},"separator",...a.defaultItems]}async function b(){s.fetchPayrollBatches=!0;try{const{data:a,error:e}=await ae(le("/payroll/payroll-batch",{query:{"fields[uploaded_bies]":"id,first_name,last_name",include:"uploadedBy"}}));if(s.fetchPayrollBatches=!1,e.value)throw e.value;u.value=a.value.data}catch(a){console.error("Error fetching payrollBatches:",a),l.hasError=!0,l.errorMessage=a.message||"خطا در دریافت فیش‌های حقوقی"}}b();async function n(a){const e=new FormData;e.append("month",Number(a.payrollBatchDate.split("/")[1])),e.append("year",Number(a.payrollBatchDate.split("/")[0])),e.append("file",a.payrollBatchFile),s.createPayrollBatch=!0;try{await x("/payroll/payroll-batch/create",{method:"POST",body:e,onResponseError({response:d}){l.hasError=!0,l.errorMessage=d._data.message||"خطا در ایجاد فیش حقوقی"}}),l.isPayrollBatchCreateDialogVisible=!1}catch(d){console.error(d)}finally{s.createPayrollBatch=!1,b()}}async function t(){s.deletePayrollBatches=!0;try{await x("/payroll/payroll-batch",{method:"DELETE",body:{ids:[m.value[0].data.id]},onResponseError({response:a}){s.deletePayrollBatches=!1,l.hasError=!0,l.errorMessage=a._data.message||"خطا در حذف فیش حقوقی"}}),s.deletePayrollBatches=!1,l.isPayrollBatchDeleteDialogVisible=!1,u.value=u.value.filter(a=>a.id!==m.value[0].data.id)}catch(a){console.error(a)}}async function _(a,e){s.fetchReports=!0;try{const d=await x("/payroll/payroll-slip/reports",{method:"GET",query:{month:a,year:e},responseType:"blob",onResponseError({response:U}){s.fetchReports=!1,l.hasError=!0,l.errorMessage=U._data.message||"خطا در دریافت گزارش فیش حقوقی"}}),c=new Blob([d],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),k=window.URL.createObjectURL(c),g=document.createElement("a");g.href=k,g.download=`فیش حقوقی مشاهده نشده ماه ${a} سال ${e}.xlsx`,document.body.appendChild(g),g.click(),window.URL.revokeObjectURL(k),document.body.removeChild(g),s.fetchReports=!1}catch(d){console.error(d)}}return(a,e)=>{const d=$("AgGridVue");return B(),V(re,{class:"app-layout"},{default:i(()=>[r(te,{modelValue:o(l).hasError,"onUpdate:modelValue":e[0]||(e[0]=c=>o(l).hasError=c),timeout:2e3,location:"center",variant:"flat",color:"error"},{default:i(()=>[R(G(o(l).errorMessage),1)]),_:1},8,["modelValue"]),j("section",ie,[r(d,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":o(v),"row-data":o(P),loading:o(s).fetchPayrollBatches,"enable-rtl":"","row-numbers":"",pagination:"",theme:o(y),"get-context-menu-items":C,onGridReady:D},null,8,["column-defs","row-data","loading","theme"])]),o(l).isPayrollBatchCreateDialogVisible?(B(),V(se,{key:0,"is-dialog-visible":o(l).isPayrollBatchCreateDialogVisible,"onUpdate:isDialogVisible":e[1]||(e[1]=c=>o(l).isPayrollBatchCreateDialogVisible=c),loading:o(s).createPayrollBatch,onSubmit:n},null,8,["is-dialog-visible","loading"])):Y("",!0),o(l).isPayrollBatchDeleteDialogVisible?(B(),V(A,{key:1,"is-dialog-visible":o(l).isPayrollBatchDeleteDialogVisible,"onUpdate:isDialogVisible":e[2]||(e[2]=c=>o(l).isPayrollBatchDeleteDialogVisible=c),title:"آیا از حذف این فیش اطمینان دارید؟",loading:o(s).deletePayrollBatches,onConfirm:t},null,8,["is-dialog-visible","loading"])):Y("",!0),r(H,null,{default:i(()=>[r(oe,{app:"",icon:"tabler-plus",size:"x-large",onClick:e[3]||(e[3]=c=>o(l).isPayrollBatchCreateDialogVisible=!0)})]),_:1})]),_:1})}}},Ue=q(ne,[["__scopeId","data-v-e49dde93"]]);export{Ue as default};
