import{_ as ae}from"./DialogCloseBtn-DcR0QzvO.js";import{V as se,c as le}from"./VCard-X2fl1T8w.js";import{an as L,a2 as M,aj as W,aG as oe,a7 as q,b as l,aK as H,aN as ie,a9 as O,av as ne,Z as re,aF as de,ap as ce,au as ue,aE as me,a3 as fe,Y as T,aQ as ge,a$ as F,a5 as I,c5 as ve,aJ as pe,am as he,al as be,aO as Ve,r as h,w as ye,f as _,o as v,e as u,l as R,c as A,t as N,v as P,F as U,h as G,m as o,$ as z,bk as _e,ah as ke,c4 as j,bY as xe,d as Ce}from"./index-CICszNDy.js";import{V as we}from"./VImg-TV0XvCl7.js";/* empty css              */import{V as Re}from"./VRow-43dtblY_.js";import{V as Y}from"./VCol-COW2noId.js";import{V as De}from"./VChip-D3lJj4hY.js";import{V as Se}from"./VTextField-Di-aN2e7.js";import{V as J}from"./VDivider-CAFUm_wM.js";import{V as Te}from"./VSkeletonLoader-BL2W3ZF9.js";import{V as Ee,a as Ae,b as Ue}from"./VList-TcnSw3ef.js";import{V as $e}from"./VSpacer-mH493LnA.js";import{V as Be}from"./VDialog-BspuEqKB.js";import{u as Ie,A as Ne,F as Pe}from"./useAGGridTheme-CS09qq7e.js";import{u as K}from"./useApi-DazJ7zrl.js";import{c as Q}from"./createUrl-DBdSN-1y.js";import{$ as Fe}from"./api-B2429s3R.js";import{i as Z}from"./helpers-CUpzJZ2r.js";import{_ as Ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as Le}from"./VSnackbar-DfwYf6bB.js";import"./createSimpleFunctional-nQRmjaiY.js";import"./VAvatar-BOZvtgvW.js";import"./VCardText-iTExjpbg.js";import"./VField-Cg_ApCzd.js";import"./form-DP4kTFIs.js";import"./VOverlay-VIOFEwcR.js";import"./VInput-BQJkaL18.js";import"./dialog-transition-ChfpJC1B.js";import"./index-9rIf2CJL.js";const Me=M({fluid:{type:Boolean,default:!1},...O(),...ie(),...H()},"VContainer"),qe=L()({name:"VContainer",props:Me(),setup(e,b){let{slots:t}=b;const{rtlClasses:i}=W(),{dimensionStyles:m}=oe(e);return q(()=>l(e.tag,{class:["v-container",{"v-container--fluid":e.fluid},i.value,e.class],style:[m.value,e.style]},t)),{}}}),He=M({text:String,...O(),...H()},"VToolbarTitle"),X=L()({name:"VToolbarTitle",props:He(),setup(e,b){let{slots:t}=b;return q(()=>{const i=!!(t.default||t.text||e.text);return l(e.tag,{class:["v-toolbar-title",e.class],style:e.style},{default:()=>{var m;return[i&&l("div",{class:"v-toolbar-title__placeholder"},[t.text?t.text():e.text,(m=t.default)==null?void 0:m.call(t)])]}})}),{}}}),Oe=[null,"prominent","default","comfortable","compact"],ze=M({absolute:Boolean,collapse:Boolean,color:String,density:{type:String,default:"default",validator:e=>Oe.includes(e)},extended:Boolean,extensionHeight:{type:[Number,String],default:48},flat:Boolean,floating:Boolean,height:{type:[Number,String],default:64},image:String,title:String,...Ve(),...O(),...be(),...he(),...H({tag:"header"}),...pe()},"VToolbar"),je=L()({name:"VToolbar",props:ze(),setup(e,b){var d;let{slots:t}=b;const{backgroundColorClasses:i,backgroundColorStyles:m}=ne(re(e,"color")),{borderClasses:V}=de(e),{elevationClasses:f}=ce(e),{roundedClasses:p}=ue(e),{themeClasses:r}=me(e),{rtlClasses:D}=W(),k=fe(!!(e.extended||(d=t.extension)!=null&&d.call(t))),x=T(()=>parseInt(Number(e.height)+(e.density==="prominent"?Number(e.height):0)-(e.density==="comfortable"?8:0)-(e.density==="compact"?16:0),10)),C=T(()=>k.value?parseInt(Number(e.extensionHeight)+(e.density==="prominent"?Number(e.extensionHeight):0)-(e.density==="comfortable"?4:0)-(e.density==="compact"?8:0),10):0);return ge({VBtn:{variant:"text"}}),q(()=>{var w;const c=!!(e.title||t.title),S=!!(t.image||e.image),n=(w=t.extension)==null?void 0:w.call(t);return k.value=!!(e.extended||n),l(e.tag,{class:["v-toolbar",{"v-toolbar--absolute":e.absolute,"v-toolbar--collapse":e.collapse,"v-toolbar--flat":e.flat,"v-toolbar--floating":e.floating,[`v-toolbar--density-${e.density}`]:!0},i.value,V.value,f.value,p.value,r.value,D.value,e.class],style:[m.value,e.style]},{default:()=>[S&&l("div",{key:"image",class:"v-toolbar__image"},[t.image?l(F,{key:"image-defaults",disabled:!e.image,defaults:{VImg:{cover:!0,src:e.image}}},t.image):l(we,{key:"image-img",cover:!0,src:e.image},null)]),l(F,{defaults:{VTabs:{height:I(x.value)}}},{default:()=>{var E,$,B;return[l("div",{class:"v-toolbar__content",style:{height:I(x.value)}},[t.prepend&&l("div",{class:"v-toolbar__prepend"},[(E=t.prepend)==null?void 0:E.call(t)]),c&&l(X,{key:"title",text:e.title},{text:t.title}),($=t.default)==null?void 0:$.call(t),t.append&&l("div",{class:"v-toolbar__append"},[(B=t.append)==null?void 0:B.call(t)])])]}}),l(F,{defaults:{VTabs:{height:I(C.value)}}},{default:()=>[l(ve,null,{default:()=>[k.value&&l("div",{class:"v-toolbar__extension",style:{height:I(C.value)}},[n])]})]})]})}),{contentHeight:x,extensionHeight:C}}}),Ye={__name:"RelationManagerDialog",props:{isDialogVisible:{type:Boolean,required:!0},isFetchItemsPending:{type:Boolean,required:!0},items:{type:Array,required:!0},selected:{type:Array,required:!0},title:{type:String,required:!0},loading:{type:Boolean,required:!0}},emits:["update:isDialogVisible","change"],setup(e,{emit:b}){const t=e,i=b,m=d=>{i("update:isDialogVisible",d)},V=t.items,f=h(),p=h(""),r=h(V.filter(d=>t.selected.some(c=>c.id===d.id))),D=T(()=>r.value.length===V.length),k=T(()=>{const d=p.value.toLowerCase();return d?V.filter(c=>c.name.toLowerCase().indexOf(d)>-1):V}),x=T(()=>{const d=[];for(const c of r.value)d.push(c);return d});ye(r,()=>{p.value=""});function C(){i("change",r.value)}return(d,c)=>{const S=ae;return v(),_(Be,{"model-value":t.isDialogVisible,width:d.$vuetify.display.smAndDown?"auto":800,"onUpdate:modelValue":m},{default:u(()=>[l(S,{onClick:c[0]||(c[0]=n=>d.$emit("update:isDialogVisible",!1))}),l(se,null,{default:u(()=>[l(je,{color:"transparent",flat:""},{default:u(()=>[l(X,null,{default:u(()=>[N(P(e.title),1)]),_:1})]),_:1}),l(qe,null,{default:u(()=>[l(Re,{align:"center",justify:"start"},{default:u(()=>[(v(!0),A(U,null,G(o(x),(n,w)=>(v(),_(Y,{key:n.id,class:"py-1 pe-0",cols:"auto"},{default:u(()=>[l(De,{disabled:e.loading,closable:"","onClick:close":E=>o(r).splice(w,1)},{default:u(()=>[n.icon?(v(),_(z,{key:0,icon:n.icon,start:""},null,8,["icon"])):R("",!0),N(" "+P(n.name),1)]),_:2},1032,["disabled","onClick:close"])]),_:2},1024))),128)),o(D)?R("",!0):(v(),_(Y,{key:0,cols:"12"},{default:u(()=>[l(Se,{ref_key:"searchField",ref:f,modelValue:o(p),"onUpdate:modelValue":c[1]||(c[1]=n=>_e(p)?p.value=n:null),label:"Search","hide-details":"","single-line":""},null,8,["modelValue"])]),_:1}))]),_:1})]),_:1}),o(D)?R("",!0):(v(),_(J,{key:0})),e.isFetchItemsPending?(v(),A(U,{key:1},G(3,n=>l(Te,{key:n,type:"list-item"})),64)):R("",!0),l(Ee,null,{default:u(()=>[(v(!0),A(U,null,G(o(k),n=>(v(),A(U,null,[o(r).includes(n)?R("",!0):(v(),_(Ae,{key:n.id,disabled:e.loading,onClick:w=>o(r).push(n)},{prepend:u(()=>[n.icon?(v(),_(z,{key:0,disabled:e.loading,icon:n.icon},null,8,["disabled","icon"])):R("",!0)]),default:u(()=>[l(Ue,{textContent:P(n.name)},null,8,["textContent"])]),_:2},1032,["disabled","onClick"]))],64))),256))]),_:1}),l(J),l(le,null,{default:u(()=>[l($e),l(ke,{loading:e.loading,color:"purple",variant:"text",onClick:C},{default:u(()=>c[2]||(c[2]=[N(" ذخیره ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value","width"])}}},Je={class:"ag-grid-sec"},Ke={__name:"access",async setup(e){let b,t;const i=j({hasError:!1,errorMessage:"",isEditAccessDialogVisible:!1}),m=h([]),V=h([]),f=h([]),p=h([]),r=j({fetchingRoles:!1,updatingUserRoles:!1}),{theme:D}=Ie(),k=h(null),x=s=>{k.value=s.api},C=h({mode:"multiRow",enableClickSelection:!0,selectAll:"filtered",isRowSelectable:s=>s.field==="user"}),d=h([{headerName:"کاربر",field:"user"},{headerName:"نقش",field:"role"},{headerName:"مجوز",field:"permission"}]),c=h({flex:1,enableRowGroup:!0,rowGroup:!0,filter:!0}),S=s=>{s.node.isSelected()||(s.api.deselectAll(),s.node.setSelected(!0));const a=s.api.getSelectedNodes();let g=[];return a.forEach(y=>{g.push(y.groupValue.split("-")[0].trim())}),g.length?[{icon:'<i class="tabler tabler-edit" style="font-size: 18px;"></i>',name:"ویرایش دسترسی",action:()=>{E(g),$(),i.isEditAccessDialogVisible=!0}},...s.defaultItems]:[...s.defaultItems]},n=async()=>{try{const{data:s,error:a}=await K(Q("/base/user?fields[users]=id,personnel_code,first_name,last_name&fields[roles]=id,name&fields[roles.permissions]=name&include=roles.permissions"));if(a.value)throw a.value;m.value=s.value.data}catch(s){console.error("Error fetching user access:",s),i.hasError=!0,i.errorMessage="خطا در دریافت دسترسی کاربران"}},w=async()=>{r.fetchingRoles=!0;try{const{data:s,error:a}=await K(Q("/base/role?include=permissions"));if(r.fetchingRoles=!1,a.value)throw a.value;V.value=s.value.data}catch(s){console.error("Error fetching roles:",s),i.hasError=!0,i.errorMessage="خطا در دریافت لیست نقش‌ها"}},E=s=>{f.value=[],s.forEach(a=>{f.value.push(m.value.find(g=>g.personnel_code===a))})},$=()=>{f.value.length>1?p.value=[]:p.value=f.value[0].roles.map(s=>({id:s.id,name:s.name}))},B=async s=>{r.updatingUserRoles=!0;try{await Fe("/base/user-role/update",{method:"POST",body:{userId:f.value[0].id,roleIds:s.map(a=>a.id)},onResponseError({response:a}){r.updatingUserRoles=!1,i.hasError=!0,i.errorMessage=a._data.message||"خطا در بروزرسانی دسترسی‌ها"}}),r.updatingUserRoles=!1,i.isEditAccessDialogVisible=!1,ee(s)}catch(a){console.error(a)}},ee=s=>{m.value=m.value.map(a=>(a.id===f.value[0].id&&(a.roles=s.map(g=>V.value.find(y=>y.id===g.id))),a))};w(),[b,t]=xe(()=>n()),await b,t();const te=T(()=>{let s=[];return m.value.map(a=>{Z(a.roles)&&s.push({user:`${a.personnel_code} - ${a.first_name} ${a.last_name}`}),a.roles.map(g=>{Z(g.permissions)&&s.push({user:`${a.personnel_code} - ${a.first_name} ${a.last_name}`,role:g.name}),g.permissions.map(y=>s.push({user:`${a.personnel_code} - ${a.first_name} ${a.last_name}`,role:g.name,permission:y.name}))})}),s});return(s,a)=>{const g=Ye;return v(),A(U,null,[l(Le,{modelValue:o(i).hasError,"onUpdate:modelValue":a[0]||(a[0]=y=>o(i).hasError=y),timeout:2e3,location:"center",variant:"outlined",color:"error"},{default:u(()=>[N(P(o(i).errorMessage),1)]),_:1},8,["modelValue"]),o(i).isEditAccessDialogVisible?(v(),_(g,{key:0,"is-dialog-visible":o(i).isEditAccessDialogVisible,"onUpdate:isDialogVisible":a[1]||(a[1]=y=>o(i).isEditAccessDialogVisible=y),title:"دسترسی "+(o(f).length>1?"کاربران":o(f)[0].first_name+" "+o(f)[0].last_name+" ("+o(f)[0].personnel_code+")"),"is-fetch-items-pending":o(r).fetchingRoles,items:o(V),selected:o(p),loading:o(r).updatingUserRoles,onChange:B},null,8,["is-dialog-visible","title","is-fetch-items-pending","items","selected","loading"])):R("",!0),Ce("section",Je,[l(o(Pe),{theme:o(D),style:{"block-size":"100%","inline-size":"100%"},"column-defs":o(d),"row-data":o(te),"default-col-def":o(c),"row-numbers":"","cell-selection":"","row-selection":o(C),"enable-rtl":"",pagination:"","row-group-panel-show":"always","get-context-menu-items":S,"locale-text":o(Ne),onGridReady:x},null,8,["theme","column-defs","row-data","default-col-def","row-selection","locale-text"])])],64)}}},Rt=Ge(Ke,[["__scopeId","data-v-11023330"]]);export{Rt as default};
