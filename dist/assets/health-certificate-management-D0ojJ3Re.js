import{_ as oe}from"./AreYouSureDialog-BaBmVS21.js";import{_ as K}from"./DialogCloseBtn-BX6Q5C0A.js";import{r as D,f as E,o as w,e as l,b as e,m as _,v,d as A,bW as se,c as re,x as U,bC as W,am as $,bv as S,n as o,a as z,aH as P,M as Z,bJ as I,Y as ee,w as ne,bK as O,bL as de}from"./index-BjDbercT.js";import{V as q,b as Q,c as ue}from"./VCard-DLNXAE8v.js";import{V as T}from"./VCardText-DJrV3pWu.js";import{V as X}from"./VForm-myuYE_Xh.js";import{V as F}from"./VRow-LLRdI7I1.js";import{V as M}from"./VCol-qg2p72EP.js";import{V as fe}from"./VFileInput-3nJ1Z0BZ.js";import{V as L}from"./VDialog-TeVeCvfX.js";import{r as te}from"./validators-BQd4MaJQ.js";import{V as ae}from"./VTextField-DDgrD6FV.js";import{$ as x}from"./api-DjFw6eZH.js";import{u as ie}from"./useAGGridTheme-xF0dHTm9.js";import{V as me}from"./VSnackbar-CHSK6Bj4.js";import{V as ce}from"./VFab-Cl93BQx4.js";import{V as ge}from"./VLayout-vZ5Wssn-.js";import"./createSimpleFunctional-BP7hpzsR.js";/* empty css              */import"./VField-Bu2nJgTa.js";import"./VOverlay-BlrRlgQ7.js";import"./VCounter-fhqYYHf9.js";import"./dialog-transition-BfqVmbQh.js";import"./helpers-CcX6MmOA.js";import"./autofocus-CNqWoOyb.js";import"./index-CvOPxmL5.js";import"./useLogout-kPLI9xuP.js";const he={class:"text-caption d-flex justify-space-between"},pe={key:0},be={__name:"HealthCertificateAddImageDialog",props:{loading:Boolean,isDialogVisible:Boolean,progress:{type:Number,default:0},total:{type:Number,default:0},done:{type:Number,default:0},failed:{type:Number,default:0}},emits:["submit","update:isDialogVisible"],setup(n,{emit:a}){const d=n,p=a,V=D(),u=D([]),b=[f=>{if(!f.length)return"حداقل یک تصویر انتخاب کنید!";if(f.length>3e3)return"حداکثر می‌توانید 3000 تصویر انتخاب کنید!";for(const i of f){const g=i.name.split(".").pop().toLowerCase();if(!["jpg","jpeg","png"].includes(g))return"فقط فایل‌های تصویری (jpg, jpeg, png) مجاز هستند!";if(i.size>2*1024*1024)return`حجم هر تصویر باید کمتر از ${2*1024*1024/1024/1024} مگابایت باشد!`}return!0}];function H(){var f;(f=V.value)==null||f.validate().then(({valid:i})=>{i&&p("submit",{healthCertificateImages:u.value})})}function N(){p("update:isDialogVisible",!1)}function k(f){p("update:isDialogVisible",f)}return(f,i)=>{const g=K;return w(),E(L,{width:f.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":k},{default:l(()=>[e(g,{onClick:i[0]||(i[0]=h=>k(!1))}),e(q,null,{default:l(()=>[e(Q,{class:"text-h6"},{default:l(()=>[...i[2]||(i[2]=[v(" افزودن عکس ",-1)])]),_:1}),n.loading?(w(),E(T,{key:0,class:"pt-0"},{default:l(()=>[e(se,{"model-value":n.progress,height:"10",color:"primary",rounded:"",striped:"",class:"mb-2"},null,8,["model-value"]),A("div",he,[i[3]||(i[3]=A("span",null,"در حال آپلود...",-1)),A("span",null,[v(U(n.done)+" / "+U(n.total)+" ",1),n.failed?(w(),re("span",pe," | ناموفق: "+U(n.failed),1)):_("",!0),v(" | "+U(Math.round(n.progress))+"% ",1)])])]),_:1})):_("",!0),e(T,null,{default:l(()=>[e(X,{ref_key:"refVForm",ref:V,class:"mt-2","validate-on":"submit lazy",onSubmit:W(H,["prevent"])},{default:l(()=>[e(F,null,{default:l(()=>[e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e($,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...i[4]||(i[4]=[v(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e($,{color:"secondary",variant:"tonal",disabled:n.loading,onClick:N},{default:l(()=>[...i[5]||(i[5]=[v(" انصراف ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1}),e(F,null,{default:l(()=>[e(M,{cols:"12",md:"12"},{default:l(()=>[e(fe,{modelValue:o(u),"onUpdate:modelValue":i[1]||(i[1]=h=>S(u)?u.value=h:null),multiple:"",chips:"","show-size":"",disabled:n.loading,label:"تصاویر (حداکثر 3000 فایل)",accept:"image/*",rules:b},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},Ve={__name:"HealthCertificateCreateDialog",props:{isDialogVisible:{type:Boolean,required:!0},loading:{type:Boolean,required:!0}},emits:["submit","update:isDialogVisible"],setup(n,{emit:a}){const d=n,p=a,V=D(),u=D(null),b=D([]),H=[()=>!!u.value||"لطفا دوره را انتخاب کنید!"];function N(){var i;(i=V.value)==null||i.validate().then(({valid:g})=>{g&&p("submit",{healthCertificateDate:u.value,healthCertificateName:b.value})})}function k(){p("update:isDialogVisible",!1)}function f(i){p("update:isDialogVisible",i)}return(i,g)=>{const h=K,s=z("PersianDatetimePicker");return w(),E(L,{width:i.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":f},{default:l(()=>[e(h,{onClick:g[0]||(g[0]=y=>f(!1))}),e(q,null,{default:l(()=>[e(T,null,{default:l(()=>[g[5]||(g[5]=A("h4",{class:"text-h5 text-center mb-2"}," ایجاد گروه شناسنامه جدید ",-1)),e(X,{ref_key:"refVForm",ref:V,class:"mt-6","validate-on":"submit lazy",onSubmit:W(N,["prevent"])},{default:l(()=>[e(F,null,{default:l(()=>[e(M,{cols:"12",md:"6"},{default:l(()=>[e(P,{disabled:n.loading},{default:l(()=>[e(o(ae),{modelValue:o(b),"onUpdate:modelValue":g[1]||(g[1]=y=>S(b)?b.value=y:null),rules:["requiredValidator"in i?i.requiredValidator:o(te)],disabled:n.loading,simple:"",label:"نام"},null,8,["modelValue","rules","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",md:"6"},{default:l(()=>[e(P,{rules:H,disabled:n.loading},{default:l(()=>[e(s,{modelValue:o(u),"onUpdate:modelValue":g[2]||(g[2]=y=>S(u)?u.value=y:null),disabled:n.loading,type:"year-month",simple:"",label:"دوره شناسنامه"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e($,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...g[3]||(g[3]=[v(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e($,{color:"secondary",variant:"tonal",onClick:k},{default:l(()=>[...g[4]||(g[4]=[v(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},Ce={style:{height:"400px"}},De={__name:"HealthCertificateDetailsDialog",props:{file:Object,loading:Boolean,isDialogVisible:Boolean},emits:["update:isDialogVisible"],setup(n,{emit:a}){const d=n,p=a,V=I({fetchingHealthCertificateUsers:!1}),u=D([]),b=I({hasError:!1,message:""}),H=D(null);async function N(h){var s,y;if(h){V.fetchingHealthCertificateUsers=!0,(s=H.value)==null||s.setGridOption("loading",!0);try{const C=await x(`/hse/health-certificate/file/${h}`,{method:"GET"});u.value=(C==null?void 0:C.data)??[],b.hasError=!1,b.message=""}catch(C){console.error("fetchHealthCertificateUsers error:",C),b.hasError=!0,b.message=(C==null?void 0:C.message)??"خطا در دریافت کاربران",u.value=[]}finally{V.fetchingHealthCertificateUsers=!1,(y=H.value)==null||y.setGridOption("loading",!1)}}}const{theme:k}=ie();function f(h){H.value=h.api,H.value.setGridOption("loading",!0)}const i=D([{headerName:"نام",field:"name"},{headerName:"کد پرسنلی",field:"personnel_code"},{headerName:"شناسنامه",field:"health_certificate",sort:"desc"}]),g=ee(()=>{var h;return(h=u.value)==null?void 0:h.map(s=>{var C;const y=(C=s.health_certificate)==null?void 0:C.some(J=>J.health_certificate_id===d.file.id);return{name:`${s.first_name} ${s.last_name}`,personnel_code:s.personnel_code,health_certificate:y?"دارد":"آپلود نشده"}})});return ne(()=>{var h;return(h=d.file)==null?void 0:h.id},h=>{h?N(h):u.value=[]},{immediate:!0}),(h,s)=>{const y=z("AgGridVue");return w(),E(L,{width:h.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":s[1]||(s[1]=C=>p("update:isDialogVisible",C))},{default:l(()=>[e(q,null,{default:l(()=>[e(Q,{class:"text-h6 text-center"},{default:l(()=>[v(" کاربران دوره شناسنامه: "+U(d.file.name),1)]),_:1}),A("section",Ce,[e(y,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":o(i),"row-data":o(g),"enable-rtl":"","row-numbers":"",pagination:"",theme:o(k),onGridReady:f},null,8,["column-defs","row-data","theme"])]),e(ue,{class:"justify-end"},{default:l(()=>[e($,{color:"primary",text:"",onClick:s[0]||(s[0]=C=>p("update:isDialogVisible",!1))},{default:l(()=>[...s[2]||(s[2]=[v(" بستن ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},ve=Z(De,[["__scopeId","data-v-7a38a024"]]),ye={__name:"HealthCertificateEditDialog",props:{file:Object,loading:Boolean,isDialogVisible:Boolean},emits:["submit","update:isDialogVisible"],setup(n,{emit:a}){const d=n,p=a,V=D(),u=D(null),b=D(d.file.name);function H(){var f;(f=V.value)==null||f.validate().then(({valid:i})=>{i&&p("submit",{healthCertificateDate:u.value,healthCertificateName:b.value})})}function N(){p("update:isDialogVisible",!1)}function k(f){p("update:isDialogVisible",f)}return(f,i)=>{const g=K,h=z("PersianDatetimePicker");return w(),E(L,{width:f.$vuetify.display.smAndDown?"auto":900,"model-value":d.isDialogVisible,"onUpdate:modelValue":k},{default:l(()=>[e(g,{onClick:i[0]||(i[0]=s=>k(!1))}),e(q,null,{default:l(()=>[e(Q,{class:"text-h6"},{default:l(()=>[v(" ویرایش شناسنامه: "+U(d.file.name),1)]),_:1}),e(T,null,{default:l(()=>[e(F,null,{default:l(()=>[e(M,{cols:"12",sm:"6"},{default:l(()=>[A("p",null,[i[3]||(i[3]=A("strong",null,"ماه:",-1)),v(" "+U(d.file.month),1)])]),_:1}),e(M,{cols:"12",sm:"6"},{default:l(()=>[A("p",null,[i[4]||(i[4]=A("strong",null,"سال:",-1)),v(" "+U(d.file.year),1)])]),_:1})]),_:1}),e(X,{ref_key:"refVForm",ref:V,class:"mt-6","validate-on":"submit lazy",onSubmit:W(H,["prevent"])},{default:l(()=>[e(F,null,{default:l(()=>[e(M,{cols:"12",md:"6"},{default:l(()=>[e(P,{disabled:n.loading},{default:l(()=>[e(ae,{modelValue:o(b),"onUpdate:modelValue":i[1]||(i[1]=s=>S(b)?b.value=s:null),rules:["requiredValidator"in f?f.requiredValidator:o(te)],disabled:n.loading,simple:"",label:"نام"},null,8,["modelValue","rules","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",md:"6"},{default:l(()=>[e(P,{disabled:n.loading},{default:l(()=>[e(h,{modelValue:o(u),"onUpdate:modelValue":i[2]||(i[2]=s=>S(u)?u.value=s:null),disabled:n.loading,type:"year-month",simple:"",label:"دوره شناسنامه"},null,8,["modelValue","disabled"])]),_:1},8,["disabled"])]),_:1}),e(M,{cols:"12",class:"d-flex flex-wrap justify-center gap-4"},{default:l(()=>[e($,{type:"submit",disabled:n.loading,loading:n.loading},{default:l(()=>[...i[5]||(i[5]=[v(" ذخیره ",-1)])]),_:1},8,["disabled","loading"]),e($,{color:"secondary",variant:"tonal",onClick:N},{default:l(()=>[...i[6]||(i[6]=[v(" انصراف ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1})]),_:1},8,["width","model-value"])}}},He={style:{"block-size":"100%"}},we={__name:"health-certificate-management",setup(n){const a=I({hasError:!1,errorMessage:"",isHealthCertificateCreateDialogVisible:!1,isHealthCertificateEditDialogVisible:!1,isHealthCertificateAddImageDialogVisible:!1,isHealthCertificateDeleteDialogVisible:!1,isHealthCertificateDetailsDialogVisible:!1}),d=I({createHealthCertificate:!1,editHealthCertificate:!1,addImageHealthCertificate:!1,fetchingHealthCertificates:!1,deleteHealthCertificate:!1,detailsHealthCertificate:!1}),p=D([]),V=D(null),u=D([]),b=D(null),{theme:H}=ie();function N(m){b.value=m.api,b.value.setGridOption("loading",!0)}const k=D([{headerName:"نام",field:"name"},{headerName:"ماه",field:"month"},{headerName:"سال",field:"year"},{headerName:"بارگذاری توسط",field:"uploadedBy"},{headerName:"آخرین ویرایش توسط",field:"editedBy"},{headerName:"تاریخ بارگذاری",field:"createdAt",valueFormatter:m=>O(m.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"تاریخ آخرین ویرایش",field:"updatedAt",valueFormatter:m=>O(m.value,"jYYYY-jMM-jDD HH:mm:ss").format("jYYYY/jMM/jD HH:mm:ss")},{headerName:"عملیات",field:"actions",cellRendererSelector:m=>({component:"Actions",params:{onDeleteClick:t=>{u.value=[t],a.isHealthCertificateDeleteDialogVisible=!0},onDetailsClick:t=>{u.value=[t],V.value=p.value.find(c=>c.id===t.data.id),a.isHealthCertificateDetailsDialogVisible=!0},onEditClick:t=>{u.value=[t],V.value=p.value.find(c=>c.id===t.data.id),a.isHealthCertificateEditDialogVisible=!0},onAddImageClick:t=>{u.value=[t],V.value=p.value.find(c=>c.id===t.data.id),a.isHealthCertificateAddImageDialogVisible=!0}}})}]),f=ee(()=>{var m;return(m=p.value)==null?void 0:m.map(t=>{var c,r;return{id:t.id,name:t.name,month:t.month,year:t.year,uploadedBy:((c=t.uploadedBy)==null?void 0:c.fullName)||"--",editedBy:((r=t.editedBy)==null?void 0:r.fullName)||"--",createdAt:O(t.createdAt).format("jYYYY-jMM-jDD HH:mm:ss"),updatedAt:O(t.updatedAt).format("jYYYY-jMM-jDD HH:mm:ss"),actions:{deletable:!0,detailsable:!0,editable:{status:!0,mode:"view"},addImage:!0}}})});async function i(){var m,t,c;d.fetchingHealthCertificates=!0,(m=b.value)==null||m.setGridOption("loading",!0);try{const r=await x("/hse/health-certificate/file/",{method:"GET"});p.value=((t=r==null?void 0:r.data)==null?void 0:t.healthCertificates)||[]}catch(r){console.error("Error fetching healthCertificates:",r),a.hasError=!0,a.errorMessage=r.message||"خطا در دریافت دوره‌های شناسنامه‌ها"}finally{d.fetchingHealthCertificates=!1,(c=b.value)==null||c.setGridOption("loading",!1)}}i();async function g(m){const t=new FormData;t.append("month",Number(m.healthCertificateDate.split("/")[1])),t.append("year",Number(m.healthCertificateDate.split("/")[0])),t.append("file_name",m.healthCertificateName),d.createHealthCertificate=!0;try{await x("/hse/health-certificate/file/",{method:"POST",body:t,onResponseError({response:c}){var r,Y;if(a.hasError=!0,(r=c._data)!=null&&r.errors){const j=Object.values(c._data.errors).flat().join(" | ");a.errorMessage=j}else a.errorMessage=((Y=c._data)==null?void 0:Y.message)||"خطا در ایجاد"}}),a.isHealthCertificateCreateDialogVisible=!1}catch(c){console.error(c)}finally{d.createHealthCertificate=!1,i()}}async function h(m){const t=V.value.id,c=new FormData;m.healthCertificateDate&&(c.append("month",Number(m.healthCertificateDate.split("/")[1])),c.append("year",Number(m.healthCertificateDate.split("/")[0]))),c.append("file_name",m.healthCertificateName),d.editHealthCertificate=!0;try{await x(`/hse/health-certificate/file/${t}`,{method:"POST",body:c,onResponseError({response:r}){var Y,j;if(a.hasError=!0,(Y=r._data)!=null&&Y.errors){const B=Object.values(r._data.errors).flat().join(" | ");a.errorMessage=B}else a.errorMessage=((j=r._data)==null?void 0:j.message)||"خطا در ویرایش"}}),a.isHealthCertificateEditDialogVisible=!1}catch(r){console.error(r)}finally{d.editHealthCertificate=!1,i()}}const s=I({active:!1,total:0,done:0,failed:0,percent:0});function y(){s.active=!1,s.total=0,s.done=0,s.failed=0,s.percent=0}async function C(m){const t=V.value.id,c=V.value.year,r=m.healthCertificateImages||[],Y=19;if(r.length){y(),s.active=!0,s.total=r.length,d.addImageHealthCertificate=!0,a.hasError=!1,a.errorMessage="";try{for(let j=0;j<r.length;j+=Y){const B=r.slice(j,j+Y),G=new FormData;B.forEach(R=>G.append("images[]",R,R.name)),G.append("id",String(t)),G.append("year",String(c));try{await x("/hse/health-certificate/file/image",{method:"POST",body:G}),s.done+=B.length}catch(R){console.error("batch upload failed:",R),s.failed+=B.length,a.hasError=!0,a.errorMessage="برخی از فایل‌ها بارگذاری نشدند."}const le=s.done+s.failed;s.percent=s.total?le/s.total*100:0}a.isHealthCertificateAddImageDialogVisible=!1}catch(j){console.error(j),a.hasError=!0,a.errorMessage="خطای غیرمنتظره در آپلود"}finally{d.addImageHealthCertificate=!1,s.active=!1,i()}}}async function J(){const m=u.value[0].data.id;d.deleteHealthCertificate=!0;try{await x(`/hse/health-certificate/file/${m}`,{method:"DELETE",onResponseError({response:t}){d.deleteHealthCertificate=!1,a.hasError=!0,a.errorMessage=t._data.message||"خطا در حذف"}}),d.deleteHealthCertificate=!1,a.isHealthCertificateDeleteDialogVisible=!1,p.value=p.value.filter(t=>t.id!==u.value[0].data.id)}catch(t){console.error(t)}}return(m,t)=>{const c=z("AgGridVue");return w(),E(ge,{class:"app-layout"},{default:l(()=>[e(me,{modelValue:o(a).hasError,"onUpdate:modelValue":t[0]||(t[0]=r=>o(a).hasError=r),timeout:2e3,location:"center",variant:"flat",color:"error"},{default:l(()=>[v(U(o(a).errorMessage),1)]),_:1},8,["modelValue"]),A("section",He,[e(c,{style:{"block-size":"100%","inline-size":"100%"},"column-defs":o(k),"row-data":o(f),"enable-rtl":"","row-numbers":"",pagination:"",theme:o(H),onGridReady:N},null,8,["column-defs","row-data","theme"])]),o(a).isHealthCertificateCreateDialogVisible?(w(),E(Ve,{key:0,"is-dialog-visible":o(a).isHealthCertificateCreateDialogVisible,"onUpdate:isDialogVisible":t[1]||(t[1]=r=>o(a).isHealthCertificateCreateDialogVisible=r),loading:o(d).createHealthCertificate,onSubmit:g},null,8,["is-dialog-visible","loading"])):_("",!0),o(a).isHealthCertificateEditDialogVisible?(w(),E(ye,{key:1,"is-dialog-visible":o(a).isHealthCertificateEditDialogVisible,"onUpdate:isDialogVisible":t[2]||(t[2]=r=>o(a).isHealthCertificateEditDialogVisible=r),loading:o(d).editHealthCertificate,file:o(V),onSubmit:h},null,8,["is-dialog-visible","loading","file"])):_("",!0),o(a).isHealthCertificateAddImageDialogVisible?(w(),E(be,{key:2,"is-dialog-visible":o(a).isHealthCertificateAddImageDialogVisible,"onUpdate:isDialogVisible":t[3]||(t[3]=r=>o(a).isHealthCertificateAddImageDialogVisible=r),loading:o(d).addImageHealthCertificate||o(s).active,progress:o(s).percent,total:o(s).total,done:o(s).done,failed:o(s).failed,onSubmit:C},null,8,["is-dialog-visible","loading","progress","total","done","failed"])):_("",!0),o(a).isHealthCertificateDetailsDialogVisible?(w(),E(ve,{key:3,"is-dialog-visible":o(a).isHealthCertificateDetailsDialogVisible,"onUpdate:isDialogVisible":t[4]||(t[4]=r=>o(a).isHealthCertificateDetailsDialogVisible=r),loading:o(d).detailsHealthCertificate,file:o(V)},null,8,["is-dialog-visible","loading","file"])):_("",!0),o(a).isHealthCertificateDeleteDialogVisible?(w(),E(oe,{key:4,"is-dialog-visible":o(a).isHealthCertificateDeleteDialogVisible,"onUpdate:isDialogVisible":t[5]||(t[5]=r=>o(a).isHealthCertificateDeleteDialogVisible=r),title:"آیا از حذف این شناسنامه اطمینان دارید؟",loading:o(d).deleteHealthCertificate,onConfirm:J},null,8,["is-dialog-visible","loading"])):_("",!0),e(de,null,{default:l(()=>[e(ce,{app:"",icon:"tabler-plus",size:"x-large",onClick:t[6]||(t[6]=r=>o(a).isHealthCertificateCreateDialogVisible=!0)})]),_:1})]),_:1})}}},Xe=Z(we,[["__scopeId","data-v-ac1f93f2"]]);export{Xe as default};
